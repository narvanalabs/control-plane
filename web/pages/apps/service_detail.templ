package apps

import (
	"fmt"
	"strings"
	
	"github.com/narvanalabs/control-plane/web/layouts"
	"github.com/narvanalabs/control-plane/web/components/button"
	"github.com/narvanalabs/control-plane/web/components/icon"
	"github.com/narvanalabs/control-plane/web/components/table"
	"github.com/narvanalabs/control-plane/web/components/tabs"
	"github.com/narvanalabs/control-plane/web/components/breadcrumb"
	"github.com/narvanalabs/control-plane/web/components/card"
	"github.com/narvanalabs/control-plane/web/components/input"
	"github.com/narvanalabs/control-plane/web/components/label"
	"github.com/narvanalabs/control-plane/web/components/dialog"
	"github.com/narvanalabs/control-plane/web/components/selectbox"
	"github.com/narvanalabs/control-plane/web/api"
	"github.com/narvanalabs/control-plane/web/utils"
	"github.com/narvanalabs/control-plane/web/components/badge"
	"github.com/narvanalabs/control-plane/web/components/tooltip"
	"github.com/narvanalabs/control-plane/internal/models"
)

// ServiceDetailData holds the data for the service detail page
type ServiceDetailData struct {
	App             api.App
	Service         api.Service
	Deployments     []api.Deployment
	Logs            []api.Log
	BuildLogs       string
	Token           string
	SuccessMsg      string
	ErrorMsg        string
	ServiceState    models.ServiceState // Current state of the service
	AppSecrets      []api.Secret        // App-level secrets for display in environment tab
}

// ServiceDetail renders the service detail page
templ ServiceDetail(data ServiceDetailData) {
	@layouts.PageWithSidebar(data.Service.Name, "/apps") {
		@layouts.Flash(layouts.FlashProps{Success: data.SuccessMsg, Error: data.ErrorMsg})

		<div class="space-y-6">
			// Breadcrumb
			@breadcrumb.Breadcrumb() {
				@breadcrumb.List() {
					@breadcrumb.Item() {
						@breadcrumb.Link(breadcrumb.LinkProps{Href: "/apps"}) {
							Apps
						}
					}
					@breadcrumb.Separator()
					@breadcrumb.Item() {
						@breadcrumb.Link(breadcrumb.LinkProps{Href: "/apps/" + data.App.ID}) {
							{ data.App.Name }
						}
					}
					@breadcrumb.Separator()
					@breadcrumb.Item() {
						@breadcrumb.Page() {
							{ data.Service.Name }
						}
					}
				}
			}
			
			// Header with status and actions
			<div class="flex items-center justify-between">
				<div class="flex items-center gap-3">
					<div class="p-2 rounded-lg bg-muted flex items-center justify-center size-10">
						if data.Service.SourceType == "database" {
							@icon.Database(icon.Props{Class: "size-5"})
						} else {
							@icon.Box(icon.Props{Class: "size-5 text-muted-foreground"})
						}
					</div>
					<div>
						<div class="flex items-center gap-2">
							<h1 class="text-2xl font-bold">{ data.Service.Name }</h1>
							if len(data.Deployments) > 0 {
								@DeploymentStatusBadge(data.Deployments[0].Status)
							}
						</div>
						<p class="text-muted-foreground text-sm">
							if data.Service.SourceType == "database" && data.Service.Database != nil {
								if data.Service.Database.Type == "postgres" {
									PostgreSQL v{ data.Service.Database.Version }
								} else if data.Service.Database.Type == "sqlite" {
									SQLite v{ data.Service.Database.Version }
								} else {
									{ data.Service.Database.Type } v{ data.Service.Database.Version }
								}
							} else if data.Service.SourceType == "image" {
								// Legacy image source type
								// **Validates: Requirements 9.2**
								Image (Legacy)
							} else {
								// Display "Git Repository" for git source type
								// **Validates: Requirements 10.3**
								Git Repository
								if data.Service.GitRepo != "" {
									- { data.Service.GitRepo }
								}
							}
						</p>
					</div>
				</div>
				<div class="flex items-center gap-2">
					@ServiceActionButtons(data)
				</div>
			</div>
			
			// Tabs
			@tabs.Tabs() {
				@tabs.List() {
					@tabs.Trigger(tabs.TriggerProps{Value: "overview", IsActive: data.SuccessMsg == ""}) {
						Overview
					}
					@tabs.Trigger(tabs.TriggerProps{Value: "deployments"}) {
						Deployments
					}
					@tabs.Trigger(tabs.TriggerProps{Value: "logs", IsActive: data.SuccessMsg != ""}) {
						Logs
					}
					if isDatabaseService(data.Service) {
						@tabs.Trigger(tabs.TriggerProps{Value: "secrets"}) {
							Secrets
						}
					} else {
						@tabs.Trigger(tabs.TriggerProps{Value: "environment"}) {
							Environment
						}
					}
					@tabs.Trigger(tabs.TriggerProps{Value: "domains"}) {
						Domains
					}
					@tabs.Trigger(tabs.TriggerProps{Value: "settings"}) {
						Settings
					}
				}
				
				// Overview Tab
				@tabs.Content(tabs.ContentProps{Value: "overview", IsActive: data.SuccessMsg == ""}) {
					<div class="pt-4 space-y-6">
						@ServiceOverview(data)
					</div>
				}
				
				// Deployments Tab
				@tabs.Content(tabs.ContentProps{Value: "deployments"}) {
					<div class="pt-4">
						if len(data.Deployments) == 0 {
							@EmptyState("No deployments", "Deployment history will appear here")
						} else {
							<div class="rounded-lg border overflow-hidden">
								@table.Table() {
									@table.Header() {
										@table.Row() {
											@table.Head() { Version }
											@table.Head() { Status }
											@table.Head() { Node }
											@table.Head() { Created }
											@table.Head(table.HeadProps{Class: "text-right"}) { Actions }
										}
									}
									@table.Body() {
										for _, d := range data.Deployments {
											@table.Row() {
												@table.Cell() { { "v" + intToString(d.Version) } }
												@table.Cell() { @DeploymentStatusBadge(d.Status) }
												@table.Cell() { 
													if d.NodeID != "" {
														<span class="font-mono text-xs">{ d.NodeID[:8] }</span>
													} else {
														<span class="text-muted-foreground">-</span>
													}
												}
												@table.Cell() {
													<span class="text-muted-foreground text-sm">
														{ formatTime(d.CreatedAt) }
													</span>
												}
												@table.Cell(table.CellProps{Class: "text-right"}) {
													@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm}) {
														Details
													}
												}
											}
										}
									}
								}
							</div>
						}
					</div>
				}
				
				// Logs Tab
				@tabs.Content(tabs.ContentProps{Value: "logs", IsActive: data.SuccessMsg != ""}) {
					<div class="pt-4 space-y-4">
						if data.Service.SourceType == "database" {
							// Database logs - using server logs UI pattern
							if len(data.Deployments) > 0 {
								@card.Card() {
									@card.Header() {
										<div class="flex items-center justify-between">
											<div class="flex-1 min-w-0">
												@card.Title() {
													Service Logs
												}
												@card.Description() {
													Build and runtime logs for { data.Service.Name }
												}
											</div>
										</div>
										
										<div class="mt-4 flex flex-wrap items-end gap-4 border-t pt-4">
											// Status indicator
											<div class="flex items-center gap-2">
												<span id="stream-status" class="text-xs text-zinc-500">‚óã Connecting...</span>
												if data.Deployments[0].Status == "pending" || data.Deployments[0].Status == "building" {
													<span class="text-xs text-zinc-400">‚Ä¢ Build in progress</span>
												} else if data.Deployments[0].Status == "built" || data.Deployments[0].Status == "scheduled" {
													<span class="text-xs text-zinc-400">‚Ä¢ Deployment scheduled</span>
												} else if data.Deployments[0].Status == "running" {
													<span class="text-xs text-green-500">‚Ä¢ Running</span>
												}
											</div>
											
											// Search & Actions
											<div class="flex flex-1 items-end gap-3 justify-end min-w-[300px]">
												<div class="space-y-1.5 flex-1 max-w-sm">
													@label.Label(label.Props{Class: "text-[10px] uppercase text-muted-foreground font-semibold px-0.5"}) { Search Logs }
													@input.Input(input.Props{
														ID:          "log-search",
														Placeholder: "Filter messages...",
														Class:       "h-9",
													})
												</div>
												
												<div class="flex items-center gap-1.5 pb-0.5">
													@button.Button(button.Props{
														ID:      "pause-btn",
														Variant: button.VariantOutline,
														Size:    button.SizeIcon,
														Class:   "h-9 w-9",
														Attributes: templ.Attributes{"title": "Pause/Resume Stream"},
													}) {
														<div id="pause-icon">@icon.Pause(icon.Props{Size: 16})</div>
														<div id="play-icon" class="hidden">@icon.Play(icon.Props{Size: 16})</div>
													}
													@button.Button(button.Props{
														ID:      "copy-btn",
														Variant: button.VariantOutline,
														Size:    button.SizeIcon,
														Class:   "h-9 w-9",
														Attributes: templ.Attributes{"title": "Copy Logs"},
													}) {
														@icon.Copy(icon.Props{Size: 16})
													}
													@button.Button(button.Props{
														ID:      "clear-btn",
														Variant: button.VariantOutline,
														Size:    button.SizeIcon,
														Class:   "h-9 w-9",
														Attributes: templ.Attributes{"title": "Clear Logs"},
													}) {
														@icon.Trash2(icon.Props{Size: 16})
													}
												</div>
											</div>
										</div>
									}
									@card.Content() {
										<div 
											id="live-logs"
											data-app-id={ data.App.ID }
											data-deployment-id={ data.Deployments[0].ID }
											class="h-[600px] w-full overflow-y-auto rounded-md bg-zinc-950 p-4 font-mono text-sm text-zinc-300"
										>
											if data.BuildLogs != "" {
												<div class="mb-4 pb-4 border-b border-zinc-800">
													<div class="text-zinc-500 mb-2 text-[10px] uppercase font-semibold tracking-wider">Build Output</div>
													<pre class="whitespace-pre-wrap text-zinc-300">{ data.BuildLogs }</pre>
												</div>
											} else {
												if data.Deployments[0].Status == "pending" {
													<div class="text-zinc-500 text-sm">‚è≥ Build queued - waiting for worker...</div>
												} else if data.Deployments[0].Status == "building" {
													<div class="text-zinc-500 text-sm">üî® Building - logs will appear here...</div>
												} else if data.Deployments[0].Status == "built" || data.Deployments[0].Status == "scheduled" {
													<div class="text-zinc-500 text-sm">‚úÖ Build complete - deployment starting...</div>
												} else {
													<div class="text-zinc-500 text-sm">Waiting for logs...</div>
												}
											}
										</div>
									}
								}
								
								// Log streaming script for database services
								// Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6
								<script>
									document.addEventListener('DOMContentLoaded', function() {
										const logContainer = document.getElementById('live-logs');
										const searchInput = document.getElementById('log-search');
										const pauseBtn = document.getElementById('pause-btn');
										const copyBtn = document.getElementById('copy-btn');
										const clearBtn = document.getElementById('clear-btn');
										const streamStatus = document.getElementById('stream-status');
										
										if (!logContainer) return;
										
										const appId = logContainer.dataset.appId;
										const deploymentId = logContainer.dataset.deploymentId;
										if (!appId) return;
										
										// Configuration - Requirements: 8.3, 8.6
										const MAX_LOG_LINES = 5000;
										const MAX_RECONNECT_ATTEMPTS = 10;
										const BASE_RECONNECT_DELAY = 1000;
										const MAX_RECONNECT_DELAY = 30000;
										
										let eventSource = null;
										let isPaused = false;
										let reconnectAttempts = 0;
										let reconnectTimeout = null;
										
										function buildStreamUrl() {
											return `/api/logs/stream?app_id=${appId}${deploymentId ? `&deployment_id=${deploymentId}` : ''}`;
										}
										
										function startStream() {
											if (eventSource) {
												eventSource.close();
											}
											
											if (isPaused) return;
											
											const streamUrl = buildStreamUrl();
											eventSource = new EventSource(streamUrl);
											
											eventSource.onopen = function() {
												reconnectAttempts = 0;
												updateStatus('connected');
											};
											
											// Handle named events - Requirements: 8.2
											eventSource.addEventListener('connected', function(event) {
												console.log('Stream connected:', event.data);
											});
											
											eventSource.addEventListener('log', function(event) {
												if (isPaused) return;
												try {
													const log = JSON.parse(event.data);
													appendLog(log);
													enforceLineLimit(); // Requirements: 8.3
												} catch (e) {
													console.error('Failed to parse log event:', e);
												}
											});
											
											eventSource.addEventListener('ping', function(event) {
												// Keep-alive ping
											});
											
											eventSource.addEventListener('new_deployment', function(event) {
												console.log('New deployment:', event.data);
											});
											
											eventSource.addEventListener('deployment_status', function(event) {
												console.log('Deployment status:', event.data);
											});
											
											// Fallback for generic messages
											eventSource.onmessage = function(event) {
												if (isPaused) return;
												
												try {
													const log = JSON.parse(event.data);
													if (log.message) {
														appendLog(log);
														enforceLineLimit();
													}
												} catch (e) {
													// Plain text log
													const line = document.createElement('div');
													line.className = 'flex gap-2 mb-1 log-line text-zinc-400 break-all';
													line.textContent = event.data;
													logContainer.appendChild(line);
													logContainer.scrollTop = logContainer.scrollHeight;
													enforceLineLimit();
												}
											};
											
											// Reconnection with exponential backoff - Requirements: 8.6
											eventSource.onerror = function() {
												eventSource.close();
												scheduleReconnect();
											};
										}
										
										function appendLog(log) {
											const line = document.createElement('div');
											line.className = 'flex gap-2 mb-1 log-line';
											
											// Apply search filter if active
											if (searchInput && searchInput.value) {
												const searchText = searchInput.value.toLowerCase();
												if (!log.message.toLowerCase().includes(searchText)) {
													line.classList.add('hidden');
												}
											}
											
											const time = new Date(log.timestamp || Date.now()).toLocaleTimeString('en-US', { hour12: false });
											line.innerHTML = `
												<span class="text-zinc-500 shrink-0 font-mono text-[11px]">${time}</span>
												<span class="text-zinc-400 break-all">${escapeHtml(log.message)}</span>
											`;
											logContainer.appendChild(line);
											if (!line.classList.contains('hidden')) {
												logContainer.scrollTop = logContainer.scrollHeight;
											}
										}
										
										// Requirements: 8.3 - Limit container to 5000 lines
										function enforceLineLimit() {
											while (logContainer.children.length > MAX_LOG_LINES) {
												logContainer.removeChild(logContainer.firstChild);
											}
										}
										
										// Requirements: 8.6 - Exponential backoff reconnection
										function scheduleReconnect() {
											if (isPaused) return;
											
											if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
												updateStatus('failed');
												return;
											}
											
											reconnectAttempts++;
											const delay = Math.min(
												BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1),
												MAX_RECONNECT_DELAY
											);
											
											updateStatus('reconnecting', delay);
											
											reconnectTimeout = setTimeout(function() {
												startStream();
											}, delay);
										}
										
										function updateStatus(status, delay) {
											if (!streamStatus) return;
											
											switch (status) {
												case 'connected':
													streamStatus.className = 'text-xs text-green-500 animate-pulse';
													streamStatus.textContent = '‚óè Live';
													break;
												case 'reconnecting':
													streamStatus.className = 'text-xs text-yellow-500';
													streamStatus.textContent = `‚óã Reconnecting in ${Math.round(delay / 1000)}s...`;
													break;
												case 'paused':
													streamStatus.className = 'text-xs text-zinc-500';
													streamStatus.textContent = '‚óã Paused';
													break;
												case 'failed':
													streamStatus.className = 'text-xs text-red-500';
													streamStatus.textContent = '‚óè Connection failed';
													break;
												default:
													streamStatus.className = 'text-xs text-zinc-500';
													streamStatus.textContent = '‚óã Disconnected';
											}
										}
										
										// Initial stream
										startStream();
										
										// Client-side search
										if (searchInput) {
											searchInput.addEventListener('input', function() {
												const searchText = this.value.toLowerCase();
												const lines = logContainer.querySelectorAll('.log-line');
												lines.forEach(line => {
													const content = line.textContent.toLowerCase();
													if (content.includes(searchText) || searchText === '') {
														line.classList.remove('hidden');
													} else {
														line.classList.add('hidden');
													}
												});
												logContainer.scrollTop = logContainer.scrollHeight;
											});
										}
										
										// Pause/Resume - Requirements: 8.4, 8.5
										if (pauseBtn) {
											pauseBtn.addEventListener('click', function() {
												isPaused = !isPaused;
												const pauseIcon = document.getElementById('pause-icon');
												const playIcon = document.getElementById('play-icon');
												
												if (pauseIcon) pauseIcon.classList.toggle('hidden', isPaused);
												if (playIcon) playIcon.classList.toggle('hidden', !isPaused);
												
												if (isPaused) {
													// Requirements: 8.4 - Pause streaming
													if (eventSource) eventSource.close();
													if (reconnectTimeout) {
														clearTimeout(reconnectTimeout);
														reconnectTimeout = null;
													}
													updateStatus('paused');
												} else {
													// Requirements: 8.5 - Resume streaming
													reconnectAttempts = 0;
													startStream();
												}
											});
										}
										
										// Copy content
										if (copyBtn) {
											copyBtn.addEventListener('click', function() {
												const text = logContainer.innerText;
												navigator.clipboard.writeText(text).then(() => {
													const originalHTML = this.innerHTML;
													this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>';
													setTimeout(() => {
														this.innerHTML = originalHTML;
													}, 2000);
												});
											});
										}
										
										// Clear logs
										if (clearBtn) {
											clearBtn.addEventListener('click', function() {
												logContainer.innerHTML = '';
											});
										}
										
										function escapeHtml(text) {
											const div = document.createElement('div');
											div.textContent = text;
											return div.innerHTML;
										}
										
										// Cleanup on page unload
										window.addEventListener('beforeunload', function() {
											if (eventSource) {
												eventSource.close();
											}
											if (reconnectTimeout) {
												clearTimeout(reconnectTimeout);
											}
										});
									});
								</script>
							} else {
								@EmptyState("No deployments", "Click Deploy Now to start")
							}
						} else {
							// Web service logs UI (existing)
							<div class="flex flex-wrap items-center gap-3 border-b pb-4">
								<div class="flex-1 min-w-[200px]">
									@input.Input(input.Props{
										ID:          "log-search",
										Placeholder: "Search logs...",
										Class:       "h-9",
									})
								</div>
								<div class="w-32">
									@selectbox.SelectBox(selectbox.Props{ID: "log-level-selector"}) {
										@selectbox.Trigger() {
											@selectbox.Value(selectbox.ValueProps{Placeholder: "Level"})
										}
										@selectbox.Content(selectbox.ContentProps{NoSearch: true}) {
											@selectbox.Item(selectbox.ItemProps{Value: "all", Selected: true}) { All Levels }
											@selectbox.Item(selectbox.ItemProps{Value: "info"}) { Info }
											@selectbox.Item(selectbox.ItemProps{Value: "warning"}) { Warning }
											@selectbox.Item(selectbox.ItemProps{Value: "error"}) { Error }
											@selectbox.Item(selectbox.ItemProps{Value: "debug"}) { Debug }
										}
									}
								</div>
								<div class="flex items-center gap-2">
									@button.Button(button.Props{
										ID:      "pause-logs-btn",
										Variant: button.VariantOutline,
										Size:    button.SizeIcon,
										Class:   "h-9 w-9",
										Attributes: templ.Attributes{"title": "Pause/Resume"},
									}) {
										<div id="pause-icon">@icon.Pause(icon.Props{Size: 16})</div>
										<div id="play-icon" class="hidden">@icon.Play(icon.Props{Size: 16})</div>
									}
									@button.Button(button.Props{
										ID:      "clear-logs-btn",
										Variant: button.VariantOutline,
										Size:    button.SizeIcon,
										Class:   "h-9 w-9",
										Attributes: templ.Attributes{"title": "Clear Logs"},
									}) {
										@icon.Trash2(icon.Props{Size: 16})
									}
								</div>
							</div>

							<div id="log-container" 
								data-app-id={ data.App.ID }
								data-service-name={ data.Service.Name }
								data-token={ data.Token }
								class={ "bg-zinc-950 rounded-lg p-4 font-mono text-xs text-zinc-300 h-[600px] overflow-auto", utils.If(len(data.Logs) == 0 && data.BuildLogs == "", "hidden") }
							>
								if data.BuildLogs != "" {
									<div class="mb-4 pb-4 border-b border-zinc-800">
										<div class="text-zinc-500 mb-2 text-[10px] uppercase font-semibold tracking-wider">Build Output</div>
										<pre class="whitespace-pre-wrap">{ data.BuildLogs }</pre>
									</div>
								}
								if len(data.Logs) > 0 {
									for _, log := range data.Logs {
										<div class="flex gap-2 log-entry" data-level={ log.Level }>
											<span class="text-zinc-500">{ log.Timestamp.Format("15:04:05") }</span>
											<span class={ "w-12 shrink-0 font-bold", getLogLevelClass(log.Level) }>{ log.Level }</span>
											<span class="break-all">{ log.Message }</span>
										</div>
									}
								}
							</div>
							if len(data.Logs) == 0 && data.BuildLogs == "" {
								@EmptyState("No logs", "Logs will appear here after deployments")
							}
						}
					</div>
				}
				
				// Settings Tab
				if isDatabaseService(data.Service) {
					@tabs.Content(tabs.ContentProps{Value: "secrets"}) {
						<div class="pt-4 space-y-6" id="secrets-tab" data-app-id={ data.App.ID } data-service-name={ data.Service.Name } data-db-type={ data.Service.Database.Type }>
							@card.Card() {
								@card.Header() {
									<div class="flex items-center justify-between">
										<div>
											@card.Title() { 
												@icon.Key(icon.Props{Class: "size-4 mr-2 inline"})
												Database Credentials 
											}
											@card.Description() { Auto-generated credentials injected into dependent services }
										</div>
										@button.Button(button.Props{
											ID: "reveal-secrets-btn",
											Type: "button",
											Variant: button.VariantOutline,
											Size: button.SizeSm,
										}) {
											@icon.Eye(icon.Props{Class: "size-4 mr-2"})
											<span id="reveal-btn-text">Reveal Password</span>
										}
									</div>
								}
								@card.Content() {
									<div class="space-y-4">
										<div class="rounded-lg border overflow-hidden">
											@table.Table() {
												@table.Header() {
													@table.Row() {
														@table.Head() { Environment Variable }
														@table.Head() { Value }
														@table.Head(table.HeadProps{Class: "w-24"}) { Actions }
													}
												}
												@table.Body(table.BodyProps{ID: "secrets-table-body"}) {
													// DATABASE_URL - shows password masked, not editable
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DATABASE_URL", strings.ToUpper(data.Service.Name)), "data-is-url": "true"}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DATABASE_URL</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value database-url" data-masked="true">
																{ getDatabaseURLPrefix(data.Service) }‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{ getDatabaseURLSuffix(data.Service, data.App.ID) }
															</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
																// No edit button - DATABASE_URL is derived from other values
															</div>
														}
													}
													// DB_HOST - not sensitive, not masked
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DB_HOST", strings.ToUpper(data.Service.Name))}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DB_HOST</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value" data-masked="false">{ data.App.ID }-{ data.Service.Name }.narvana.local</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																	Attributes: templ.Attributes{
																		"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s-%s.narvana.local')", data.App.ID, data.Service.Name),
																	},
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
															</div>
														}
													}
													// DB_PORT - not sensitive, not masked
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DB_PORT", strings.ToUpper(data.Service.Name))}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DB_PORT</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value" data-masked="false">{ intToString(getServicePort(data.Service)) }</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																	Attributes: templ.Attributes{
																		"onclick": fmt.Sprintf("navigator.clipboard.writeText('%d')", getServicePort(data.Service)),
																	},
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
															</div>
														}
													}
													// DB_NAME - not sensitive, not masked
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DB_NAME", strings.ToUpper(data.Service.Name))}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DB_NAME</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value" data-masked="false">{ data.Service.Name }</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																	Attributes: templ.Attributes{
																		"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s')", data.Service.Name),
																	},
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
															</div>
														}
													}
													// DB_USER - not sensitive (same as service name), not masked
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DB_USER", strings.ToUpper(data.Service.Name))}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DB_USER</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value" data-masked="false">{ data.Service.Name }</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																	Attributes: templ.Attributes{
																		"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s')", data.Service.Name),
																	},
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
															</div>
														}
													}
													// DB_PASSWORD - SENSITIVE, masked, editable
													@table.Row(table.RowProps{Class: "group", Attributes: templ.Attributes{"data-key": fmt.Sprintf("%s_DB_PASSWORD", strings.ToUpper(data.Service.Name)), "data-is-password": "true"}}) {
														@table.Cell() { 
															<code class="font-mono text-xs">{ strings.ToUpper(data.Service.Name) }_DB_PASSWORD</code>
														}
														@table.Cell() { 
															<code class="font-mono text-xs text-muted-foreground secret-value password-value" data-masked="true">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
														}
														@table.Cell() {
															<div class="flex items-center gap-1">
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 copy-secret-btn",
																}) {
																	@icon.Copy(icon.Props{Class: "size-3"})
																}
																@button.Button(button.Props{
																	Type: "button",
																	Variant: button.VariantGhost,
																	Size: button.SizeIcon,
																	Class: "h-7 w-7 edit-secret-btn",
																}) {
																	@icon.Pencil(icon.Props{Class: "size-3"})
																}
															</div>
														}
													}
												}
											}
										</div>
										
										<div class="rounded-lg border border-blue-500/20 bg-blue-500/5 p-4">
											<div class="flex gap-3">
												@icon.Info(icon.Props{Class: "size-5 text-blue-500 shrink-0 mt-0.5"})
												<div class="space-y-1">
													<p class="text-sm font-medium">How to use</p>
													<p class="text-sm text-muted-foreground">
														Add this database as a dependency in your service configuration. 
														These credentials will be automatically injected as environment variables.
													</p>
												</div>
											</div>
										</div>
									</div>
								}
							}
							
							// Edit Secret Dialog
							@dialog.Dialog(dialog.Props{ID: "edit-secret-dialog"}) {
								@dialog.Content() {
									@dialog.Header() {
										@dialog.Title() { Change Password }
										@dialog.Description() {
											Update the database password. This will also update the DATABASE_URL.
										}
									}
									<div class="space-y-4 py-4">
										@label.Label(label.Props{For: "edit-secret-value"}) { New Password }
										@input.Input(input.Props{
											ID: "edit-secret-value",
											Type: input.TypePassword,
											Placeholder: "Enter new password",
										})
										<p class="text-xs text-muted-foreground">
											Changing the password will require redeploying dependent services.
										</p>
									</div>
									@dialog.Footer() {
										@dialog.Close() {
											@button.Button(button.Props{Variant: button.VariantGhost}) { Cancel }
										}
										@button.Button(button.Props{ID: "save-secret-btn"}) { Save }
									}
								}
							}
							
							// Secrets tab script
							<script>
								document.addEventListener('DOMContentLoaded', function() {
									const secretsTab = document.getElementById('secrets-tab');
									if (!secretsTab) return;
									
									const appId = secretsTab.dataset.appId;
									const serviceName = secretsTab.dataset.serviceName;
									const dbType = secretsTab.dataset.dbType || 'postgres';
									const revealBtn = document.getElementById('reveal-secrets-btn');
									const revealBtnText = document.getElementById('reveal-btn-text');
									
									let passwordRevealed = false;
									let currentPassword = null;
									
									const serviceNameUpper = serviceName.toUpperCase();
									const passwordKey = `${serviceNameUpper}_DB_PASSWORD`;
									const urlKey = `${serviceNameUpper}_DATABASE_URL`;
									
									// Get URL parts based on database type
									function getUrlPrefix() {
										const user = serviceName;
										switch (dbType) {
											case 'mysql':
											case 'mariadb':
												return `mysql://${user}:`;
											case 'mongodb':
											case 'mongo':
												return `mongodb://${user}:`;
											case 'redis':
												return 'redis://:';
											default:
												return `postgresql://${user}:`;
										}
									}
									
									function getUrlSuffix() {
										const host = `${appId}-${serviceName}.narvana.local`;
										const port = document.querySelector(`tr[data-key="${serviceNameUpper}_DB_PORT"] .secret-value`)?.textContent?.trim() || '5432';
										const dbName = serviceName;
										if (dbType === 'redis') {
											return `@${host}:${port}`;
										}
										return `@${host}:${port}/${dbName}`;
									}
									
									function buildDatabaseUrl(password) {
										return getUrlPrefix() + password + getUrlSuffix();
									}
									
									function getMaskedUrl() {
										return getUrlPrefix() + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + getUrlSuffix();
									}
									
									// Reveal/Hide password
									if (revealBtn) {
										revealBtn.addEventListener('click', async function() {
											if (!passwordRevealed) {
												// Fetch password from API
												try {
													const res = await fetch(`/api/v1/apps/${appId}/secrets`);
													if (res.ok) {
														const data = await res.json();
														const secrets = data.secrets || [];
														const passwordSecret = secrets.find(s => s.key === passwordKey);
														
														if (passwordSecret && passwordSecret.value) {
															currentPassword = passwordSecret.value;
														} else {
															currentPassword = '(not set)';
														}
														
														// Update password display
														const passwordEl = document.querySelector('.password-value');
														if (passwordEl) {
															passwordEl.textContent = currentPassword;
															passwordEl.dataset.revealed = 'true';
														}
														
														// Update DATABASE_URL to show actual password
														const urlEl = document.querySelector('.database-url');
														if (urlEl && currentPassword !== '(not set)') {
															urlEl.textContent = buildDatabaseUrl(currentPassword);
															urlEl.dataset.revealed = 'true';
														}
														
														passwordRevealed = true;
														revealBtnText.textContent = 'Hide Password';
													}
												} catch (err) {
													console.error('Failed to fetch secrets:', err);
												}
											} else {
												// Hide password
												const passwordEl = document.querySelector('.password-value');
												if (passwordEl) {
													passwordEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
													passwordEl.dataset.revealed = 'false';
												}
												
												// Hide password in DATABASE_URL
												const urlEl = document.querySelector('.database-url');
												if (urlEl) {
													urlEl.textContent = getMaskedUrl();
													urlEl.dataset.revealed = 'false';
												}
												
												passwordRevealed = false;
												revealBtnText.textContent = 'Reveal Password';
											}
										});
									}
									
									// Copy buttons
									document.querySelectorAll('.copy-secret-btn').forEach(btn => {
										if (!btn.onclick) {
											btn.addEventListener('click', async function() {
												const row = this.closest('tr');
												const valueEl = row?.querySelector('.secret-value');
												const key = row?.dataset.key;
												const isUrl = row?.dataset.isUrl === 'true';
												const isPassword = row?.dataset.isPassword === 'true';
												
												let textToCopy = '';
												
												if (isUrl || isPassword) {
													// Need to fetch actual password if not already fetched
													if (!currentPassword) {
														try {
															const res = await fetch(`/api/v1/apps/${appId}/secrets`);
															if (res.ok) {
																const data = await res.json();
																const secrets = data.secrets || [];
																const passwordSecret = secrets.find(s => s.key === passwordKey);
																currentPassword = passwordSecret?.value || '(not set)';
															}
														} catch (err) {
															console.error('Failed to fetch secrets:', err);
														}
													}
													
													if (isUrl) {
														textToCopy = buildDatabaseUrl(currentPassword || '');
													} else {
														textToCopy = currentPassword || '';
													}
												} else {
													textToCopy = valueEl?.textContent?.trim() || '';
												}
												
												navigator.clipboard.writeText(textToCopy).then(() => {
													// Visual feedback
													const originalHTML = this.innerHTML;
													this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>';
													setTimeout(() => {
														this.innerHTML = originalHTML;
													}, 1500);
												});
											});
										}
									});
									
									// Edit button (only for password)
									document.querySelectorAll('.edit-secret-btn').forEach(btn => {
										btn.addEventListener('click', function() {
											document.getElementById('edit-secret-value').value = '';
											window.tui.dialog.open('edit-secret-dialog');
										});
									});
									
									// Save password
									const saveBtn = document.getElementById('save-secret-btn');
									if (saveBtn) {
										saveBtn.addEventListener('click', async function() {
											const newPassword = document.getElementById('edit-secret-value').value;
											if (!newPassword) return;
											
											saveBtn.disabled = true;
											saveBtn.textContent = 'Saving...';
											
											try {
												// Save the new password
												const res = await fetch(`/api/v1/apps/${appId}/secrets`, {
													method: 'POST',
													headers: { 'Content-Type': 'application/json' },
													body: JSON.stringify({ key: passwordKey, value: newPassword })
												});
												
												if (res.ok) {
													// Also update the DATABASE_URL with new password
													const newUrl = buildDatabaseUrl(newPassword);
													await fetch(`/api/v1/apps/${appId}/secrets`, {
														method: 'POST',
														headers: { 'Content-Type': 'application/json' },
														body: JSON.stringify({ key: urlKey, value: newUrl })
													});
													
													window.tui.dialog.close('edit-secret-dialog');
													
													// Update local state
													currentPassword = newPassword;
													
													// Update display if revealed
													if (passwordRevealed) {
														const passwordEl = document.querySelector('.password-value');
														if (passwordEl) passwordEl.textContent = newPassword;
														
														const urlEl = document.querySelector('.database-url');
														if (urlEl) urlEl.textContent = newUrl;
													}
												} else {
													alert('Failed to update password');
												}
											} catch (err) {
												console.error(err);
												alert('Failed to update password');
											} finally {
												saveBtn.disabled = false;
												saveBtn.textContent = 'Save';
											}
										});
									}
								});
							</script>
						</div>
					}
				}
				
				// Environment Tab - Environment variables for web services
				// **Validates: Requirements 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4**
				if !isDatabaseService(data.Service) {
					@tabs.Content(tabs.ContentProps{Value: "environment"}) {
						<div class="pt-4 space-y-6" id="env-tab-container" data-app-id={ data.App.ID } data-service-name={ data.Service.Name }>
							// Service-level Environment Variables Card
							@card.Card() {
								@card.Header() {
									<div class="flex items-center justify-between">
										<div>
											@card.Title() { 
												@icon.Settings(icon.Props{Class: "size-4 mr-2 inline"})
												Service Environment Variables
											}
											@card.Description() { 
												Variables specific to this service. These override app-level secrets with the same key.
											}
										</div>
										<div class="flex items-center gap-2">
											// Import .env button
											// **Validates: Requirements 2.1**
											<label for="env-file-input" class="cursor-pointer">
												@button.Button(button.Props{
													Type: "button",
													Variant: button.VariantOutline,
													Size: button.SizeSm,
													Attributes: templ.Attributes{"onclick": "document.getElementById('env-file-input').click()"},
												}) {
													@icon.Upload(icon.Props{Class: "size-4 mr-2"})
													Import .env
												}
											</label>
											<input type="file" id="env-file-input" accept=".env,.env.local,.env.example,.env.development,.env.production" class="hidden" />
											// Add Variable button
											// **Validates: Requirements 1.1**
											@button.Button(button.Props{
												ID: "add-env-var-btn",
												Type: "button",
												Size: button.SizeSm,
											}) {
												@icon.Plus(icon.Props{Class: "size-4 mr-2"})
												Add Variable
											}
										</div>
									</div>
								}
								@card.Content() {
									// Error display area
									// **Validates: Requirements 1.5**
									<div id="env-error-display" class="hidden mb-4 p-3 rounded-lg bg-destructive/10 border border-destructive/20 text-destructive text-sm">
										<div class="flex items-center gap-2">
											@icon.CircleAlert(icon.Props{Class: "size-4"})
											<span id="env-error-message"></span>
										</div>
									</div>
									
									// Import preview area (hidden by default)
									<div id="env-import-preview" class="hidden mb-4 p-4 rounded-lg border border-dashed bg-muted/30">
										<div class="flex items-center justify-between mb-3">
											<div class="flex items-center gap-2">
												@icon.FileText(icon.Props{Class: "size-4 text-muted-foreground"})
												<span class="text-sm font-medium">Import Preview</span>
												<span id="env-import-count" class="text-xs text-muted-foreground">(0 variables)</span>
											</div>
											<div class="flex gap-2">
												@button.Button(button.Props{
													ID: "env-import-cancel-btn",
													Type: "button",
													Variant: button.VariantGhost,
													Size: button.SizeSm,
												}) {
													Cancel
												}
												@button.Button(button.Props{
													ID: "env-import-confirm-btn",
													Type: "button",
													Size: button.SizeSm,
												}) {
													@icon.Check(icon.Props{Class: "size-4 mr-2"})
													Import All
												}
											</div>
										</div>
										<div id="env-import-list" class="max-h-48 overflow-y-auto space-y-1"></div>
									</div>
									
									// Dynamic environment variables list
									<div id="env-vars-container">
										if len(data.Service.EnvVars) == 0 {
											<div id="env-empty-state" class="text-center py-8 text-muted-foreground">
												<p class="text-sm">No environment variables configured yet.</p>
												<p class="text-xs mt-1">Click "Add Variable" to create one or import from a .env file.</p>
											</div>
										}
										<div id="env-vars-list" class="space-y-2">
											for key, value := range data.Service.EnvVars {
												// Each row is a dynamic key-value pair with auto-save on blur
												// **Validates: Requirements 1.2, 1.3, 1.4**
												<div class="env-var-row flex items-center gap-2 group" data-original-key={ key } data-saved="true">
													<div class="flex-1">
														@input.Input(input.Props{
															Class: "font-mono text-sm env-key-input",
															Value: key,
															Placeholder: "KEY_NAME",
															Attributes: templ.Attributes{
																"data-original": key,
															},
														})
													</div>
													<div class="flex-1">
														@input.Input(input.Props{
															Type: input.TypePassword,
															Class: "font-mono text-sm env-value-input",
															Value: value,
															Placeholder: "value",
															Attributes: templ.Attributes{
																"data-original": value,
															},
														})
													</div>
													<div class="flex items-center gap-1">
														// Status indicator
														<span class="env-status text-xs text-muted-foreground hidden">
															<span class="saving hidden">Saving...</span>
															<span class="saved hidden text-green-500">‚úì</span>
															<span class="error hidden text-destructive">‚úó</span>
														</span>
														// Delete button
														// **Validates: Requirements 1.4**
														@button.Button(button.Props{
															Type: "button",
															Variant: button.VariantGhost,
															Size: button.SizeIcon,
															Class: "h-8 w-8 opacity-0 group-hover:opacity-100 text-destructive hover:text-destructive env-delete-btn",
														}) {
															@icon.Trash2(icon.Props{Class: "size-4"})
														}
													</div>
												</div>
											}
										</div>
									</div>
								}
							}
							
							// App-level Secrets Card (read-only)
							// **Validates: Requirements 3.1, 3.2, 3.3, 3.4**
							@card.Card() {
								@card.Header() {
									<div class="flex items-center justify-between">
										<div>
											@card.Title() { 
												@icon.Lock(icon.Props{Class: "size-4 mr-2 inline"})
												App-Level Secrets
											}
											@card.Description() { 
												Shared secrets available to all services in this app. 
												<a href={ templ.SafeURL("/apps/" + data.App.ID + "?tab=secrets") } class="text-primary hover:underline">Manage in app settings ‚Üí</a>
											}
										</div>
									</div>
								}
								@card.Content() {
									if len(data.AppSecrets) == 0 {
										<div class="text-center py-6 text-muted-foreground">
											<p class="text-sm">No app-level secrets configured.</p>
											<p class="text-xs mt-1">
												<a href={ templ.SafeURL("/apps/" + data.App.ID + "?tab=secrets") } class="text-primary hover:underline">Add secrets in app settings</a>
											</p>
										</div>
									} else {
										<div class="rounded-lg border overflow-hidden">
											@table.Table() {
												@table.Header() {
													@table.Row() {
														@table.Head() { Key }
														@table.Head() { Value }
														@table.Head(table.HeadProps{Class: "w-24"}) { Status }
													}
												}
												@table.Body() {
													for _, secret := range data.AppSecrets {
														{{ isOverridden := isSecretOverridden(secret.Key, data.Service.EnvVars) }}
														@table.Row(table.RowProps{Class: utils.IfElse(isOverridden, "opacity-60", "")}) {
															@table.Cell() { 
																<code class="font-mono text-xs">{ secret.Key }</code>
															}
															@table.Cell() { 
																// **Validates: Requirements 3.3**
																<span class="text-muted-foreground font-mono text-xs">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
															}
															@table.Cell() {
																if isOverridden {
																	// **Validates: Requirements 3.2**
																	@badge.Badge(badge.Props{Variant: badge.VariantSecondary, Class: "text-xs"}) {
																		Overridden
																	}
																} else {
																	@badge.Badge(badge.Props{Variant: badge.VariantOutline, Class: "text-xs"}) {
																		Active
																	}
																}
															}
														}
													}
												}
											}
										</div>
									}
								}
							}
							
							// Environment Variables JavaScript
							@EnvironmentVariablesScript()
						</div>
					}
				}
				
				// Domains Tab - Port configuration and custom domains
				@tabs.Content(tabs.ContentProps{Value: "domains"}) {
					<div class="pt-4 space-y-6">
						// Port Configuration Card
						@card.Card() {
							@card.Header() {
								@card.Title() { Port Configuration }
								@card.Description() { Configure the port your application listens on }
							}
							@card.Content() {
								<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/port") } class="space-y-4">
									<div class="grid grid-cols-2 gap-4">
										<div class="space-y-2">
											@label.Label(label.Props{For: "container-port"}) { Container Port }
											@input.Input(input.Props{
												ID: "container-port",
												Name: "port",
												Type: input.TypeNumber,
												Value: fmt.Sprintf("%d", getServicePort(data.Service)),
												Placeholder: "8080",
												Attributes: templ.Attributes{"min": "1", "max": "65535"},
											})
											<p class="text-[10px] text-muted-foreground">The port your application listens on inside the container.</p>
										</div>
										<div class="space-y-2">
											@label.Label(label.Props{}) { Auto-assigned URL }
											<div class="flex items-center gap-2 h-9 px-3 rounded-md border bg-muted/50">
												<span class="text-sm text-muted-foreground font-mono truncate">
													{ data.App.ID }-{ data.Service.Name }.narvana.local
												</span>
												@tooltip.Tooltip() {
													@tooltip.Trigger() {
														@button.Button(button.Props{
															Type: "button",
															Variant: button.VariantGhost,
															Size: button.SizeIcon,
															Class: "h-6 w-6",
															Attributes: templ.Attributes{
																"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s-%s.narvana.local')", data.App.ID, data.Service.Name),
															},
														}) {
															@icon.Copy(icon.Props{Class: "size-3"})
														}
													}
													@tooltip.Content() {
														Copy URL
													}
												}
											</div>
											<p class="text-[10px] text-muted-foreground">Wildcard domain automatically assigned to this service.</p>
										</div>
									</div>
									<div class="flex justify-end">
										@button.Button(button.Props{Type: "submit"}) { Save Port }
									</div>
								</form>
							}
						}
						
						// Custom Domains Card
						@card.Card() {
							@card.Header() {
								@card.Title() { Custom Domains }
								@card.Description() { Add your own domain names to route traffic to this service }
							}
							@card.Content() {
								<div class="space-y-4">
									<div class="flex items-end gap-2">
										<div class="flex-1 space-y-2">
											@label.Label(label.Props{For: "domain-input"}) { Add new domain }
											@input.Input(input.Props{
												ID: "domain-input",
												Placeholder: "e.g., api.myapp.com",
											})
										</div>
										@button.Button(button.Props{
											ID:      "add-domain-btn",
											Type:    "button",
											Attributes: templ.Attributes{
												"data-app-id":      data.App.ID,
												"data-service-name": data.Service.Name,
											},
										}) {
											@icon.Plus(icon.Props{Class: "size-4 mr-2"})
											Add
										}
									</div>
									
									<div class="rounded-lg border overflow-hidden">
										@table.Table() {
											@table.Header() {
												@table.Row() {
													@table.Head() { Domain }
													@table.Head() { Type }
													@table.Head() { Status }
													@table.Head(table.HeadProps{Class: "text-right"}) { Action }
												}
											}
											@table.Body(table.BodyProps{ID: "domains-list"}) {
												@table.Row(table.RowProps{ID: "domains-loading"}) {
													@table.Cell(table.CellProps{Attributes: templ.Attributes{"colspan": "4"}, Class: "py-8 text-center text-muted-foreground"}) {
														Loading domains...
													}
												}
											}
										}
									</div>
									<p class="text-[10px] text-muted-foreground">
										Configure your DNS provider to point a CNAME record to 
										<span class="font-mono">narvana.local</span> (or your controller IP).
									</p>
								</div>
								
								<!-- Hidden Dialog for Domain Deletion -->
								@dialog.Dialog(dialog.Props{ID: "delete-domain-dialog"}) {
									@dialog.Content() {
										@dialog.Header() {
											@dialog.Title() { Remove Domain }
											@dialog.Description() {
												Are you sure you want to remove <strong id="delete-domain-name"></strong>? This will stop traffic to this domain.
											}
										}
										@dialog.Footer() {
											@dialog.Close() {
												@button.Button(button.Props{Variant: button.VariantGhost}) { Cancel }
											}
											@button.Button(button.Props{
												ID: "confirm-delete-domain-btn",
												Variant: button.VariantDestructive,
											}) { Remove Domain }
										}
									}
								}

								<script>
									document.addEventListener('DOMContentLoaded', () => {
										const appId = document.getElementById('add-domain-btn')?.dataset.appId;
										const serviceName = document.getElementById('add-domain-btn')?.dataset.serviceName;
										if (!appId) return;

										const list = document.getElementById('domains-list');
										const input = document.getElementById('domain-input');
										const addBtn = document.getElementById('add-domain-btn');
										const deleteConfirmBtn = document.getElementById('confirm-delete-domain-btn');
										let domainToDeleteId = null;

										// Load domains
										fetch(`/api/v1/apps/${appId}/domains`)
											.then(r => r.json())
											.then(data => {
												list.innerHTML = '';
												const domains = (data.domains || []).filter(d => d.service === serviceName);
												
												if (domains.length === 0) {
													list.innerHTML = `
														<tr class="border-b transition-colors hover:bg-muted/50">
															<td colspan="4" class="p-2 align-middle py-8 text-center text-muted-foreground">
																No custom domains configured.
															</td>
														</tr>
													`;
													return;
												}

												domains.forEach(d => {
													const row = document.createElement('tr');
													row.className = 'border-b transition-colors hover:bg-muted/50 group';
													row.innerHTML = `
														<td class="p-2 align-middle">
															<a href="http://${d.domain}" target="_blank" class="font-mono text-sm hover:underline">
																${d.domain}
															</a>
														</td>
														<td class="p-2 align-middle">
															<span class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors bg-secondary text-secondary-foreground">
																${d.is_wildcard ? 'Wildcard' : 'Custom'}
															</span>
														</td>
														<td class="p-2 align-middle">
															<span class="inline-flex items-center gap-1.5 rounded-md border px-2.5 py-0.5 text-xs font-semibold bg-green-500/10 text-green-500 border-green-500/20">
																<span class="size-1.5 rounded-full bg-green-500"></span>
																Active
															</span>
														</td>
														<td class="p-2 align-middle text-right">
															<button 
																class="delete-domain inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 w-9 opacity-0 group-hover:opacity-100"
																data-id="${d.id}"
																data-domain="${d.domain}"
																title="Remove domain"
																type="button"
															>
																<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
															</button>
														</td>
													`;
													list.appendChild(row);
												});

												// Bind deletes using TemplUI dialog
												document.querySelectorAll('.delete-domain').forEach(btn => {
													btn.addEventListener('click', (e) => {
														const id = e.currentTarget.dataset.id;
														const domain = e.currentTarget.dataset.domain;
														domainToDeleteId = id;
														
														document.getElementById('delete-domain-name').textContent = domain;
														window.tui.dialog.open('delete-domain-dialog');
													});
												});
											});

										// Confirm delete action
										if (deleteConfirmBtn) {
											deleteConfirmBtn.addEventListener('click', async () => {
												if (!domainToDeleteId) return;
												
												deleteConfirmBtn.disabled = true;
												deleteConfirmBtn.textContent = 'Removing...';
												
												try {
													const res = await fetch(`/api/v1/apps/${appId}/domains/${domainToDeleteId}`, { method: 'DELETE' });
													if (res.ok) {
														window.location.reload();
													} else {
														alert('Failed to delete domain');
														deleteConfirmBtn.disabled = false;
														deleteConfirmBtn.textContent = 'Remove Domain';
													}
												} catch (err) {
													console.error(err);
													deleteConfirmBtn.disabled = false;
													deleteConfirmBtn.textContent = 'Remove Domain';
												}
											});
										}

										// Add domain logic
										addBtn.addEventListener('click', async () => {
											const domain = input.value.trim();
											if (!domain) return;
											
											addBtn.disabled = true;
											addBtn.textContent = 'Adding...';

											try {
												const res = await fetch(`/api/v1/apps/${appId}/domains`, {
													method: 'POST',
													headers: { 'Content-Type': 'application/json' },
													body: JSON.stringify({ service: serviceName, domain })
												});
												
												if (res.ok) {
													input.value = '';
													window.location.reload();
												} else {
													const err = await res.json();
													alert(err.error || 'Failed to add domain');
												}
											} catch (error) {
												console.error(error);
												alert('Failed to connect to server');
											} finally {
												addBtn.disabled = false;
												addBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-4 mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Add';
											}
										});
									});
								</script>
							}
						}
					</div>
				}
				
				// Secrets Tab - Database credentials (only for database services)
				@tabs.Content(tabs.ContentProps{Value: "settings"}) {
					<div class="pt-4 space-y-6">
						@card.Card() {
							@card.Header() {
								@card.Title() { Service Configuration }
								@card.Description() { Update build and runtime settings }
							}
							@card.Content() {
								<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name) } class="space-y-4">
									<div class="grid grid-cols-2 gap-4">
										<div class="space-y-2">
											@label.Label(label.Props{For: "replicas"}) { Replicas }
											@input.Input(input.Props{
												ID: "replicas",
												Name: "replicas",
												Type: input.TypeNumber,
												Value: fmt.Sprintf("%d", data.Service.Replicas),
												Attributes: templ.Attributes{"min": "0", "max": "10"},
											})
										</div>
										<div class="space-y-2">
											@label.Label(label.Props{For: "strategy"}) { Build Strategy }
											@selectbox.SelectBox(selectbox.Props{ID: "strategy"}) {
												@selectbox.Trigger() {
													@selectbox.Value(selectbox.ValueProps{Placeholder: "Select strategy"})
												}
												@selectbox.Content() {
													@selectbox.Item(selectbox.ItemProps{Value: "auto", Selected: data.Service.BuildStrategy == "auto"}) { Auto-detect }
													@selectbox.Item(selectbox.ItemProps{Value: "flake", Selected: data.Service.BuildStrategy == "flake"}) { Flake.nix }
													@selectbox.Item(selectbox.ItemProps{Value: "dockerfile", Selected: data.Service.BuildStrategy == "dockerfile"}) { Dockerfile }
													@selectbox.Item(selectbox.ItemProps{Value: "nixpacks", Selected: data.Service.BuildStrategy == "nixpacks"}) { Nixpacks }
												}
											}
											<input type="hidden" name="strategy" id="hidden_strategy" value={ string(data.Service.BuildStrategy) } />
										</div>
									</div>
									<div class="space-y-2">
										@label.Label(label.Props{For: "depends_on"}) { Depends On }
										@input.Input(input.Props{
											ID: "depends_on",
											Name: "depends_on",
											Placeholder: "other-service, another-service",
											Value: strings.Join(data.Service.DependsOn, ", "),
										})
										<p class="text-[10px] text-muted-foreground">Comma-separated list of service names this service depends on.</p>
									</div>
									<div class="flex justify-end">
										@button.Button(button.Props{Type: "submit"}) { Save Changes }
									</div>
								</form>
							}
						}


							
						@card.Card() {
							@card.Header() {
								@card.Title() { Custom Domains }
								@card.Description() { Manage custom domain names for this service }
							}
							@card.Content() {
								<div class="space-y-4">
									<div class="flex items-end gap-2">
										<div class="flex-1 space-y-2">
											@label.Label(label.Props{For: "domain-input"}) { Add new domain }
											@input.Input(input.Props{
												ID: "domain-input",
												Placeholder: "e.g., api.myapp.com",
											})
										</div>
										@button.Button(button.Props{
											ID:      "add-domain-btn",
											Type:    "button",
											Attributes: templ.Attributes{
												"data-app-id":      data.App.ID,
												"data-service-name": data.Service.Name,
											},
										}) {
											@icon.Plus(icon.Props{Class: "size-4 mr-2"})
											Add
										}
									</div>
									
									<div class="rounded-lg border bg-zinc-900/50">
										<table class="w-full text-sm">
											<thead class="bg-zinc-900/50 text-left text-xs font-medium text-zinc-400">
												<tr>
													<th class="px-4 py-3">Domain</th>
													<th class="px-4 py-3">Status</th>
													<th class="px-4 py-3 text-right">Action</th>
												</tr>
											</thead>
											<tbody id="domains-list" class="divide-y divide-zinc-800/50">
												<!-- Populated via JS -->
												<tr id="domains-loading">
													<td colspan="3" class="px-4 py-8 text-center text-zinc-500">
														Loading domains...
													</td>
												</tr>
											</tbody>
										</table>
									</div>
									<p class="text-[10px] text-zinc-500">
										Note: You must configure your DNS provider to point a CNAME record to 
										<span class="font-mono text-zinc-400">narvana.local</span> (or your controller IP).
									</p>
								</div>
								
								<!-- Hidden Dialog for Domain Deletion -->
								@dialog.Dialog(dialog.Props{ID: "delete-domain-dialog"}) {
									@dialog.Content() {
										@dialog.Header() {
											@dialog.Title() { Remove Domain }
											@dialog.Description() {
												Are you sure you want to remove <strong id="delete-domain-name"></strong>? This will stop traffic to this domain.
											}
										}
										@dialog.Footer() {
											@dialog.Close() {
												@button.Button(button.Props{Variant: button.VariantGhost}) { Cancel }
											}
											@button.Button(button.Props{
												ID: "confirm-delete-domain-btn",
												Variant: button.VariantDestructive,
											}) { Remove Domain }
										}
									}
								}

								<script>
									document.addEventListener('DOMContentLoaded', () => {
										const appId = document.getElementById('add-domain-btn')?.dataset.appId;
										const serviceName = document.getElementById('add-domain-btn')?.dataset.serviceName;
										if (!appId) return;

										const list = document.getElementById('domains-list');
										const input = document.getElementById('domain-input');
										const addBtn = document.getElementById('add-domain-btn');
										const deleteConfirmBtn = document.getElementById('confirm-delete-domain-btn');
										let domainToDeleteId = null;

										// Load domains
										fetch(`/api/v1/apps/${appId}/domains`)
											.then(r => r.json())
											.then(data => {
												list.innerHTML = '';
												const domains = (data.domains || []).filter(d => d.service === serviceName);
												
												if (domains.length === 0) {
													list.innerHTML = `
														<tr>
															<td colspan="3" class="px-4 py-8 text-center text-zinc-500">
																No custom domains configured.
															</td>
														</tr>
													`;
													return;
												}

												domains.forEach(d => {
													const row = document.createElement('tr');
													row.className = 'group hover:bg-zinc-900/50 transition-colors';
													row.innerHTML = `
														<td class="px-4 py-3 font-mono text-zinc-300">
															<a href="http://${d.domain}" target="_blank" class="hover:underline hover:text-white">
																${d.domain}
															</a>
														</td>
														<td class="px-4 py-3">
															<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-500 text-[10px] font-medium border border-emerald-500/20">
																<span class="size-1 rounded-full bg-emerald-500"></span>
																Active
															</span>
														</td>
														<td class="px-4 py-3 text-right">
															<button 
																class="delete-domain opacity-0 group-hover:opacity-100 transition-opacity p-1.5 rounded-md hover:bg-zinc-800 text-zinc-500 hover:text-red-400"
																data-id="${d.id}"
																data-domain="${d.domain}"
																title="Remove domain"
																type="button"
															>
																<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
															</button>
														</td>
													`;
													list.appendChild(row);
												});

												// Bind deletes using TemplUI dialog
												document.querySelectorAll('.delete-domain').forEach(btn => {
													btn.addEventListener('click', (e) => {
														const id = e.currentTarget.dataset.id;
														const domain = e.currentTarget.dataset.domain;
														domainToDeleteId = id;
														
														document.getElementById('delete-domain-name').textContent = domain;
														window.tui.dialog.open('delete-domain-dialog');
													});
												});
											});

										// Confirm delete action
										if (deleteConfirmBtn) {
											deleteConfirmBtn.addEventListener('click', async () => {
												if (!domainToDeleteId) return;
												
												deleteConfirmBtn.disabled = true;
												deleteConfirmBtn.textContent = 'Removing...';
												
												try {
													const res = await fetch(`/api/v1/apps/${appId}/domains/${domainToDeleteId}`, { method: 'DELETE' });
													if (res.ok) {
														window.location.reload();
													} else {
														alert('Failed to delete domain');
														deleteConfirmBtn.disabled = false;
														deleteConfirmBtn.textContent = 'Remove Domain';
													}
												} catch (err) {
													console.error(err);
													deleteConfirmBtn.disabled = false;
													deleteConfirmBtn.textContent = 'Remove Domain';
												}
											});
										}

										// Add domain logic remains same...
										addBtn.addEventListener('click', async () => {
											const domain = input.value.trim();
											if (!domain) return;
											
											addBtn.disabled = true;
											addBtn.textContent = 'Adding...';

											try {
												const res = await fetch(`/api/v1/apps/${appId}/domains`, {
													method: 'POST',
													headers: { 'Content-Type': 'application/json' },
													body: JSON.stringify({ service: serviceName, domain })
												});
												
												if (res.ok) {
													input.value = '';
													// Reload to show new domain
													window.location.reload();
												} else {
													const err = await res.json();
													alert(err.error || 'Failed to add domain');
												}
											} catch (error) {
												console.error(error);
												alert('Failed to connect to server');
											} finally {
												addBtn.disabled = false;
												addBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-4 mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Add';
											}
										});
									});
								</script>
							}
						}

						@card.Card(card.Props{Class: "border-destructive/50"}) {
							@card.Header() {
								@card.Title(card.TitleProps{Class: "text-destructive"}) { Danger Zone }
								@card.Description() { Irreversible actions for this service }
							}
							@card.Content() {
								<div class="flex items-center justify-between">
									<div>
										<p class="font-medium text-sm">Delete Service</p>
										<p class="text-xs text-muted-foreground">Permanently remove this service from the application.</p>
									</div>
									@dialog.Dialog(dialog.Props{ID: "delete-service-dialog"}) {
										@dialog.Trigger() {
											@button.Button(button.Props{
												Variant: button.VariantDestructive,
												Size:    button.SizeSm,
											}) {
												@icon.Trash2(icon.Props{Class: "size-4 mr-2"})
												Delete Service
											}
										}
										@dialog.Content() {
											@dialog.Header() {
												@dialog.Title() { Delete Service }
												@dialog.Description() {
													Are you sure you want to delete <strong>{ data.Service.Name }</strong>? This action is permanent.
												}
											}
											@dialog.Footer() {
												@dialog.Close() {
													@button.Button(button.Props{Variant: button.VariantGhost}) { Cancel }
												}
												<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/delete") }>
													@button.Button(button.Props{Type: "submit", Variant: button.VariantDestructive}) { Delete Service }
												</form>
											}
										}
									}
								</div>
							}
						}
					</div>
				}
			}
		</div>
		@ServiceDetailScript(data.App.ID, data.Service.Name)
		
		// Include live logs script for database services
		if data.Service.SourceType == "database" {
			<script src="/assets/js/live-logs.js"></script>
		}
		
		// Terminal Dialog - shown when Terminal button is clicked for running non-database services
		// **Validates: Requirements 23.1, 23.2, 23.3, 23.4, 23.5**
		if data.ServiceState == models.ServiceStateRunning && data.Service.SourceType != "database" {
			// Load JetBrains Mono font and xterm.js library for terminal
			<link rel="preconnect" href="https://fonts.googleapis.com"/>
			<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
			<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"/>
			<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
			
			<dialog 
				id="terminal-dialog" 
				class="fixed inset-0 m-auto rounded-lg border border-border bg-background p-0 backdrop:bg-black/50 max-w-5xl w-[95vw] max-h-[90vh] overflow-hidden shadow-lg"
			>
				// Dialog header
				<div class="flex items-center justify-between border-b border-border px-6 py-4">
					<div>
						<h2 class="text-lg font-semibold flex items-center gap-2">
							@icon.Terminal(icon.Props{Class: "size-5"})
							Service Terminal
						</h2>
						<p class="text-sm text-muted-foreground mt-0.5">
							Interactive shell session for { data.Service.Name }
						</p>
					</div>
				</div>
				
				// Dialog content - terminal panel
				<div class="px-6 py-4">
					@TerminalPanelDialog(data)
				</div>
				
				// Dialog footer with quick commands and close button
				<div class="flex items-center justify-between border-t border-border px-6 py-4">
					<div class="flex flex-1 items-center gap-2">
						<p class="text-[10px] uppercase text-muted-foreground font-semibold">Common:</p>
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "top\n"}}) { top }
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "ps aux\n"}}) { ps }
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "df -h\n"}}) { disk }
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "free -m\n"}}) { ram }
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "ls -la\n"}}) { ls }
						@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeSm, Class: "h-7 text-xs dialog-terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "env\n"}}) { env }
					</div>
					
					// Close terminal button with confirmation
					@button.Button(button.Props{
						ID:      "terminal-close-btn",
						Variant: button.VariantOutline,
					}) { 
						Close Terminal 
					}
				</div>
			</dialog>
			
			// Close confirmation dialog
			<dialog 
				id="terminal-close-confirm-dialog" 
				class="fixed inset-0 m-auto rounded-lg border border-border bg-background p-0 backdrop:bg-black/50 max-w-md w-[95vw] shadow-lg"
			>
				<div class="px-6 py-4">
					<h3 class="text-lg font-semibold">Terminate Session?</h3>
					<p class="text-sm text-muted-foreground mt-2">
						Are you sure you want to close the terminal? All running processes in this session will be terminated.
					</p>
				</div>
				<div class="flex items-center justify-end gap-2 border-t border-border px-6 py-4">
					@button.Button(button.Props{
						ID:      "terminal-close-cancel-btn",
						Variant: button.VariantGhost,
					}) { 
						Cancel 
					}
					@button.Button(button.Props{
						ID:      "terminal-close-confirm-btn",
						Variant: button.VariantDestructive,
					}) { 
						Terminate & Close 
					}
				</div>
			</dialog>
			
			// Script to handle close confirmation
			<script>
				(function() {
					const terminalDialog = document.getElementById('terminal-dialog');
					const confirmDialog = document.getElementById('terminal-close-confirm-dialog');
					const closeBtn = document.getElementById('terminal-close-btn');
					const cancelBtn = document.getElementById('terminal-close-cancel-btn');
					const confirmBtn = document.getElementById('terminal-close-confirm-btn');
					
					if (closeBtn && confirmDialog) {
						closeBtn.addEventListener('click', () => {
							confirmDialog.showModal();
						});
					}
					
					if (cancelBtn && confirmDialog) {
						cancelBtn.addEventListener('click', () => {
							confirmDialog.close();
						});
					}
					
					if (confirmBtn && terminalDialog && confirmDialog) {
						confirmBtn.addEventListener('click', () => {
							confirmDialog.close();
							terminalDialog.close();
						});
					}
				})();
			</script>
		}
	}
}

// LegacyImageMigrationNotice renders a migration notice for services with source_type "image"
// **Validates: Requirements 9.2**
templ LegacyImageMigrationNotice() {
	<div class="rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 mb-4">
		<div class="flex items-start gap-3">
			<div class="size-8 rounded-lg bg-amber-500/10 flex items-center justify-center flex-shrink-0 mt-0.5">
				@icon.TriangleAlert(icon.Props{Class: "size-4 text-amber-500"})
			</div>
			<div class="flex-1 min-w-0">
				<h4 class="font-semibold text-amber-200">Migration Required</h4>
				<p class="text-sm text-amber-200/80 mt-1">
					This service uses the legacy "image" source type which is no longer supported. 
					Please migrate to a Git-based source by updating the service configuration in the Settings tab.
				</p>
				<div class="mt-3">
					@button.Button(button.Props{
						Variant: button.VariantOutline,
						Size: button.SizeSm,
						Class: "border-amber-500/30 text-amber-200 hover:bg-amber-500/10",
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "settings"},
					}) {
						@icon.Settings(icon.Props{Class: "size-4 mr-1"})
						Go to Settings
					}
				</div>
			</div>
		</div>
	</div>
}

// ServiceOverview dispatches to the appropriate overview based on service type
templ ServiceOverview(data ServiceDetailData) {
	// Show migration notice for legacy image services
	// **Validates: Requirements 9.2**
	if data.Service.SourceType == "image" {
		@LegacyImageMigrationNotice()
	}
	
	if isDatabaseService(data.Service) {
		@DatabaseServiceOverview(data)
	} else {
		@WebServiceOverview(data)
	}
}

// ServiceStatusBanner renders the deployment status banner (shared by both overview types)
templ ServiceStatusBanner(data ServiceDetailData) {
	if len(data.Deployments) > 0 {
		{{ latestDep := data.Deployments[0] }}
		<div class={ 
			"rounded-lg border p-4",
			utils.IfElse(latestDep.Status == "running", "bg-green-500/5 border-green-500/20", ""),
			utils.IfElse(latestDep.Status == "failed", "bg-destructive/5 border-destructive/20", ""),
			utils.IfElse(latestDep.Status == "building" || latestDep.Status == "deploying", "bg-primary/5 border-primary/20", ""),
		}>
			<div class="flex items-center justify-between">
				<div class="flex items-center gap-3">
					if latestDep.Status == "running" {
						<div class="size-3 rounded-full bg-green-500 animate-pulse"></div>
					} else if latestDep.Status == "failed" {
						<div class="size-3 rounded-full bg-destructive"></div>
					} else if latestDep.Status == "building" || latestDep.Status == "deploying" {
						@icon.Loader(icon.Props{Class: "size-4 animate-spin text-primary"})
					} else {
						<div class="size-3 rounded-full bg-muted-foreground"></div>
					}
					<div>
						<p class="font-medium">
							if latestDep.Status == "running" {
								Service is running
							} else if latestDep.Status == "failed" {
								Deployment failed
							} else if latestDep.Status == "building" {
								Building...
							} else if latestDep.Status == "deploying" {
								Deploying...
							} else if latestDep.Status == "stopped" {
								Service stopped
							} else {
								{ latestDep.Status }
							}
						</p>
						<p class="text-xs text-muted-foreground">
							v{ intToString(latestDep.Version) } ‚Ä¢ { formatTime(latestDep.CreatedAt) }
							if latestDep.NodeID != "" {
								 ‚Ä¢ Node { latestDep.NodeID[:8] }
							}
						</p>
					</div>
				</div>
				<div class="flex items-center gap-2">
					if latestDep.Status == "failed" {
						<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/retry") }>
							@button.Button(button.Props{Type: "submit", Size: button.SizeSm}) {
								@icon.RotateCcw(icon.Props{Class: "size-4 mr-1"})
								Retry
							}
						</form>
					}
					@button.Button(button.Props{
						Variant: button.VariantOutline,
						Size: button.SizeSm,
						Href: "#",
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "logs"},
					}) {
						View Logs
					}
				</div>
			</div>
		</div>
	} else {
		// No deployments yet - prompt to deploy
		<div class="rounded-lg border border-dashed p-8 text-center">
			<div class="mx-auto size-12 rounded-full bg-muted flex items-center justify-center mb-4">
				@icon.Rocket(icon.Props{Class: "size-6 text-muted-foreground"})
			</div>
			<h3 class="font-semibold">Ready to deploy</h3>
			<p class="text-sm text-muted-foreground mt-1 mb-4">
				This service hasn't been deployed yet. Click deploy to get started.
			</p>
			<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }>
				@button.Button(button.Props{Type: "submit"}) {
					@icon.Rocket(icon.Props{Class: "size-4 mr-2"})
					Deploy Now
				}
			</form>
		</div>
	}
}

// DatabaseServiceOverview renders an overview for database services
templ DatabaseServiceOverview(data ServiceDetailData) {
	// Status Banner
	@ServiceStatusBanner(data)
	
	// Quick Info Grid
	<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
		// Engine & Version
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-primary/10 flex items-center justify-center">
						@icon.Database(icon.Props{Class: "size-5 text-primary"})
					</div>
				</div>
				<h3 class="font-semibold">Engine</h3>
				if data.Service.Database != nil {
					<p class="text-2xl font-bold mt-1 capitalize">{ data.Service.Database.Type }</p>
					<p class="text-xs text-muted-foreground">v{ data.Service.Database.Version }</p>
				}
			}
		}
		
		// Port
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
						@icon.Globe(icon.Props{Class: "size-5 text-blue-500"})
					</div>
				</div>
				<h3 class="font-semibold">Port</h3>
				<p class="text-2xl font-bold mt-1 font-mono">{ intToString(getServicePort(data.Service)) }</p>
				<p class="text-xs text-muted-foreground">default port</p>
			}
		}
		
		// Replicas
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-green-500/10 flex items-center justify-center">
						@icon.Layers(icon.Props{Class: "size-5 text-green-500"})
					</div>
				</div>
				<h3 class="font-semibold">Instances</h3>
				<p class="text-2xl font-bold mt-1">{ intToString(data.Service.Replicas) }</p>
				<p class="text-xs text-muted-foreground">replica(s)</p>
			}
		}
	</div>
	
	// Connection Details Card
	@card.Card() {
		@card.Header() {
			@card.Title() { Connection Details }
			@card.Description() { Connection info for this database }
		}
		@card.Content() {
			<div class="space-y-4">
				// Host
				<div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
					<div>
						<p class="text-xs text-muted-foreground uppercase font-medium">Host</p>
						<p class="font-mono text-sm">{ data.App.ID }-{ data.Service.Name }.narvana.local</p>
					</div>
					@tooltip.Tooltip() {
						@tooltip.Trigger() {
							@button.Button(button.Props{
								Type: "button",
								Variant: button.VariantGhost,
								Size: button.SizeIcon,
								Class: "h-8 w-8",
								Attributes: templ.Attributes{
									"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s-%s.narvana.local')", data.App.ID, data.Service.Name),
								},
							}) {
								@icon.Copy(icon.Props{Class: "size-4"})
							}
						}
						@tooltip.Content() { Copy }
					}
				</div>
				
				// Port
				<div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
					<div>
						<p class="text-xs text-muted-foreground uppercase font-medium">Port</p>
						<p class="font-mono text-sm">{ intToString(getServicePort(data.Service)) }</p>
					</div>
					@tooltip.Tooltip() {
						@tooltip.Trigger() {
							@button.Button(button.Props{
								Type: "button",
								Variant: button.VariantGhost,
								Size: button.SizeIcon,
								Class: "h-8 w-8",
								Attributes: templ.Attributes{
									"onclick": fmt.Sprintf("navigator.clipboard.writeText('%d')", getServicePort(data.Service)),
								},
							}) {
								@icon.Copy(icon.Props{Class: "size-4"})
							}
						}
						@tooltip.Content() { Copy }
					}
				</div>
				
				// Database Name
				<div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
					<div>
						<p class="text-xs text-muted-foreground uppercase font-medium">Database</p>
						<p class="font-mono text-sm">{ data.Service.Name }</p>
					</div>
					@tooltip.Tooltip() {
						@tooltip.Trigger() {
							@button.Button(button.Props{
								Type: "button",
								Variant: button.VariantGhost,
								Size: button.SizeIcon,
								Class: "h-8 w-8",
								Attributes: templ.Attributes{
									"onclick": fmt.Sprintf("navigator.clipboard.writeText('%s')", data.Service.Name),
								},
							}) {
								@icon.Copy(icon.Props{Class: "size-4"})
							}
						}
						@tooltip.Content() { Copy }
					}
				</div>
			</div>
		}
	}
	
	// Dependent Services
	{{ dependents := getDependentServices(data.App, data.Service.Name) }}
	if len(dependents) > 0 {
		@card.Card() {
			@card.Header() {
				@card.Title() { Dependent Services }
				@card.Description() { Services that use this database }
			}
			@card.Content() {
				<div class="flex flex-wrap gap-2">
					for _, dep := range dependents {
						<a href={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + dep) } class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border bg-muted/50 hover:bg-muted transition-colors">
							@icon.Box(icon.Props{Class: "size-4 text-muted-foreground"})
							<span class="text-sm font-medium">{ dep }</span>
							@icon.ArrowRight(icon.Props{Class: "size-3 text-muted-foreground"})
						</a>
					}
				</div>
			}
		}
	}
}

// WebServiceOverview renders an overview for web/application services
templ WebServiceOverview(data ServiceDetailData) {
	// Status Banner
	@ServiceStatusBanner(data)
	
	// Quick Actions Grid
	<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
		// Scaling
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-primary/10 flex items-center justify-center">
						@icon.Layers(icon.Props{Class: "size-5 text-primary"})
					</div>
					@dialog.Dialog(dialog.Props{ID: "scale-dialog"}) {
						@dialog.Trigger() {
							@button.Button(button.Props{Variant: button.VariantGhost, Size: button.SizeIcon, Class: "size-8"}) {
								@icon.Settings(icon.Props{Class: "size-4"})
							}
						}
						@dialog.Content() {
							@dialog.Header() {
								@dialog.Title() { Scale Service }
								@dialog.Description() { Adjust the number of instances for { data.Service.Name } }
							}
							<form method="POST" action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name) } class="space-y-4">
								@label.Label(label.Props{For: "replicas"}) { Number of Instances }
								@input.Input(input.Props{
									ID: "replicas",
									Name: "replicas",
									Type: input.TypeNumber,
									Value: intToString(data.Service.Replicas),
									Attributes: templ.Attributes{"min": "0", "max": "10"},
								})
								<p class="text-xs text-muted-foreground">Set to 0 to stop all instances.</p>
								@dialog.Footer() {
									@dialog.Close() {
										@button.Button(button.Props{Variant: button.VariantGhost}) { Cancel }
									}
									@button.Button(button.Props{Type: "submit"}) { Save }
								}
							</form>
						}
					}
				</div>
				<h3 class="font-semibold">Instances</h3>
				<p class="text-2xl font-bold mt-1">{ intToString(data.Service.Replicas) }</p>
				<p class="text-xs text-muted-foreground">replica(s) configured</p>
			}
		}
		
		// Port / Networking
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
						@icon.Globe(icon.Props{Class: "size-5 text-blue-500"})
					</div>
					@button.Button(button.Props{
						Variant: button.VariantGhost, 
						Size: button.SizeIcon, 
						Class: "size-8",
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "domains"},
					}) {
						@icon.Settings(icon.Props{Class: "size-4"})
					}
				</div>
				<h3 class="font-semibold">Port</h3>
				<p class="text-2xl font-bold mt-1 font-mono">{ intToString(getServicePort(data.Service)) }</p>
				<p class="text-xs text-muted-foreground">container port</p>
			}
		}
		
		// Source / Git
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-orange-500/10 flex items-center justify-center">
						@icon.GitBranch(icon.Props{Class: "size-5 text-orange-500"})
					</div>
					@button.Button(button.Props{
						Variant: button.VariantGhost, 
						Size: button.SizeIcon, 
						Class: "size-8",
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "settings"},
					}) {
						@icon.Settings(icon.Props{Class: "size-4"})
					}
				</div>
				<h3 class="font-semibold">Source</h3>
				if data.Service.GitRepo != "" {
					<p class="text-sm font-mono mt-1 truncate" title={ data.Service.GitRepo }>{ data.Service.GitRepo }</p>
					<p class="text-xs text-muted-foreground">{ utils.IfElse(data.Service.GitRef != "", data.Service.GitRef, "main") }</p>
				} else {
					<p class="text-sm text-muted-foreground mt-1">Not configured</p>
				}
			}
		}
		
		// Build Strategy
		@card.Card(card.Props{Class: "group hover:border-primary/50 transition-colors"}) {
			@card.Content(card.ContentProps{Class: "pt-6"}) {
				<div class="flex items-center justify-between mb-3">
					<div class="size-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
						@icon.Hammer(icon.Props{Class: "size-5 text-purple-500"})
					</div>
					@button.Button(button.Props{
						Variant: button.VariantGhost, 
						Size: button.SizeIcon, 
						Class: "size-8",
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "settings"},
					}) {
						@icon.Settings(icon.Props{Class: "size-4"})
					}
				</div>
				<h3 class="font-semibold">Build</h3>
				<p class="text-sm font-medium mt-1 capitalize">
					if data.Service.BuildStrategy != "" {
						{ string(data.Service.BuildStrategy) }
					} else {
						Auto-detect
					}
				</p>
				<p class="text-xs text-muted-foreground">build strategy</p>
			}
		}
	</div>
	
	// Recent Activity / Deployments
	if len(data.Deployments) > 0 {
		@card.Card() {
			@card.Header() {
				<div class="flex items-center justify-between">
					@card.Title() { Recent Deployments }
					@button.Button(button.Props{
						Variant: button.VariantGhost,
						Size: button.SizeSm,
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "deployments"},
					}) {
						View All
						@icon.ArrowRight(icon.Props{Class: "size-4 ml-1"})
					}
				</div>
			}
			@card.Content() {
				<div class="space-y-3">
					for i, dep := range data.Deployments {
						if i < 3 {
							<div class="flex items-center justify-between py-2 border-b last:border-0">
								<div class="flex items-center gap-3">
									@DeploymentStatusBadge(dep.Status)
									<div>
										<p class="text-sm font-medium">v{ intToString(dep.Version) }</p>
										<p class="text-xs text-muted-foreground">{ formatTime(dep.CreatedAt) }</p>
									</div>
								</div>
								if dep.NodeID != "" {
									<span class="text-xs font-mono text-muted-foreground">{ dep.NodeID[:8] }</span>
								}
							</div>
						}
					}
				</div>
			}
		}
	}
	
	// Dependencies
	if len(data.Service.DependsOn) > 0 {
		@card.Card() {
			@card.Header() {
				@card.Title() { Dependencies }
				@card.Description() { Services this service depends on }
			}
			@card.Content() {
				<div class="flex flex-wrap gap-2">
					for _, dep := range data.Service.DependsOn {
						<a href={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + dep) } class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border bg-muted/50 hover:bg-muted transition-colors">
							@icon.Box(icon.Props{Class: "size-4 text-muted-foreground"})
							<span class="text-sm font-medium">{ dep }</span>
							@icon.ArrowRight(icon.Props{Class: "size-3 text-muted-foreground"})
						</a>
					}
				</div>
			}
		}
	}
	
	// Environment Variables Quick View
	if len(data.Service.EnvVars) > 0 {
		@card.Card() {
			@card.Header() {
				<div class="flex items-center justify-between">
					<div>
						@card.Title() { Environment Variables }
						@card.Description() { { intToString(len(data.Service.EnvVars)) } variable(s) configured }
					</div>
					@button.Button(button.Props{
						Variant: button.VariantOutline,
						Size: button.SizeSm,
						Attributes: templ.Attributes{"data-tui-tabs-trigger": "settings"},
					}) {
						Manage
					}
				</div>
			}
			@card.Content() {
				<div class="flex flex-wrap gap-2">
					for key := range data.Service.EnvVars {
						@badge.Badge(badge.Props{Variant: badge.VariantSecondary, Class: "font-mono text-xs"}) {
							{ key }
						}
					}
				</div>
			}
		}
	}
}

templ ServiceDetailScript(appID string, serviceName string) {
	<script>
		function drawConnections() {
			const svg = document.getElementById('flow-connections');
			if (!svg) return;
			
			svg.innerHTML = '';
			const svgRect = svg.getBoundingClientRect();
			
			const network = document.querySelector('[data-flow-node="network"]');
			const service = document.querySelector('[data-flow-node="service"]');
			const resources = document.querySelectorAll('[data-flow-node="resources"] > div');
			
			if (network && service) {
				const nRect = network.getBoundingClientRect();
				const sRect = service.getBoundingClientRect();
				
				const x1 = nRect.right - svgRect.left;
				const y1 = nRect.top + nRect.height / 2 - svgRect.top;
				const x2 = sRect.left - svgRect.left;
				const y2 = sRect.top + sRect.height / 2 - svgRect.top;
				
				drawPath(svg, x1, y1, x2, y2);
			}
			
			if (service) {
				const sRect = service.getBoundingClientRect();
				const x1 = sRect.right - svgRect.left;
				const y1 = sRect.top + sRect.height / 2 - svgRect.top;
				
				resources.forEach(res => {
					const rRect = res.getBoundingClientRect();
					const x2 = rRect.left - svgRect.left;
					const y2 = rRect.top + rRect.height / 2 - svgRect.top;
					
					drawPath(svg, x1, y1, x2, y2);
				});
			}
		}

		function drawPath(svg, x1, y1, x2, y2) {
			const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
			const dx = (x2 - x1) / 2;
			const d = `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
			
			path.setAttribute('d', d);
			path.setAttribute('stroke', 'rgba(63, 63, 70, 0.4)');
			path.setAttribute('stroke-width', '1.5');
			path.setAttribute('fill', 'none');
			
			svg.appendChild(path);
		}

		document.addEventListener('DOMContentLoaded', () => {
			setTimeout(drawConnections, 100);
			window.addEventListener('resize', drawConnections);
			
			// Terminal Logic
			let term = null;
			let fitAddon = null;
			let ws = null;

			const termTrigger = document.querySelector('[data-tui-dialog-trigger="service-terminal-dialog"]');
			const termContent = document.querySelector('[data-tui-dialog-content][data-dialog-instance="service-terminal-dialog"]');

			if (termTrigger) {
				termTrigger.addEventListener('click', function() {
					if (!term) {
						// Initialize terminal
						setTimeout(() => {
							term = new Terminal({
								cursorBlink: true,
								cursorStyle: 'underline',
								theme: {
									background: '#09090b',
									foreground: '#d4d4d8',
									cursor: '#71717a',
									selectionBackground: '#27272a',
									black: '#09090b',
									red: '#ef4444',
									green: '#22c55e',
									yellow: '#f59e0b',
									blue: '#3b82f6',
									magenta: '#a855f7',
									cyan: '#06b6d4',
									white: '#fafafa',
									brightBlack: '#71717a',
									brightRed: '#f87171',
									brightGreen: '#4ade80',
									brightYellow: '#fbbf24',
									brightBlue: '#60a5fa',
									brightMagenta: '#c084fc',
									brightCyan: '#22d3ee',
									brightWhite: '#ffffff'
								},
								fontSize: 14,
								lineHeight: 1.2,
								fontFamily: '"JetBrains Mono", Menlo, Monaco, Consolas, "Courier New", monospace',
								scrollback: 5000
							});

							fitAddon = new FitAddon.FitAddon();
							term.loadAddon(fitAddon);
							term.open(document.getElementById('svc-terminal'));
							fitAddon.fit();

							// Handle input
							term.onData(data => {
								if (ws && ws.readyState === WebSocket.OPEN) {
									ws.send(data);
								}
							});

							// Socket
							ws = initServiceWebSocket(term, fitAddon);

							// Resize
							window.addEventListener('resize', () => fitAddon.fit());
							
							// Quick commands
							document.querySelectorAll('.quick-svc-cmd').forEach(btn => {
								btn.addEventListener('click', () => {
									const cmd = btn.getAttribute('data-cmd');
									if (ws && ws.readyState === WebSocket.OPEN) {
										ws.send(cmd);
									}
									term.focus();
								});
							});

							const terminateBtn = document.getElementById('confirm-svc-terminate-btn');
							if (terminateBtn) {
								terminateBtn.addEventListener('click', function() {
									const closeConfirmDialog = document.querySelector('[data-tui-dialog-close="svc-term-close-confirm"]');
									const mainTerminalDialog = document.querySelector('[data-tui-dialog-close="service-terminal-dialog"]');
									
									// Close both dialogs
									if (closeConfirmDialog) closeConfirmDialog.click();
									if (mainTerminalDialog) mainTerminalDialog.click();
									
									// Explicitly kill terminal
									if (ws) {
										if (ws.readyState === WebSocket.OPEN) {
											ws.send(JSON.stringify({ type: 'terminate' }));
										}
										ws.close();
										ws = null;
									}
									if (term) {
										term.dispose();
										term = null;
										document.getElementById('svc-terminal').innerHTML = '';
									}
								});
							}
						}, 100);
					} else {
						if (!ws || ws.readyState !== WebSocket.OPEN) {
							ws = initServiceWebSocket(term, fitAddon);
						}
						setTimeout(() => {
							fitAddon.fit();
							term.focus();
						}, 100);
					}
				});
			}

			function initServiceWebSocket(term, fitAddon) {
				const statusBadge = document.getElementById('svc-term-status');
				const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
				const path = window.location.pathname; // Should be /apps/{appID}/services/{serviceName}
				const wsUrl = `${protocol}//${window.location.host}${path}/console/ws`;
				
				const newWs = new WebSocket(wsUrl);
				newWs.binaryType = 'arraybuffer';

				newWs.onopen = () => {
					if (statusBadge) statusBadge.innerHTML = '<span class="mr-1.5 size-2 rounded-full bg-green-500"></span> Connected';
					term.focus();
					newWs.send(JSON.stringify({
						type: 'resize',
						rows: term.rows,
						cols: term.cols
					}));
				};

				newWs.onmessage = (event) => {
					term.write(new Uint8Array(event.data));
				};

				newWs.onclose = () => {
					if (statusBadge) statusBadge.innerHTML = '<span class="mr-1.5 size-2 rounded-full bg-red-500"></span> Disconnected';
					term.write('\r\n\x1b[31mTerminal connection closed.\x1b[0m\r\n');
				};

				return newWs;
			}
		});
	</script>
}

// ServiceActionButtons renders the appropriate action buttons based on service state.
// **Validates: Requirements 7.1, 7.2, 7.3, 7.4, 7.5, 7.6**
templ ServiceActionButtons(data ServiceDetailData) {
	switch data.ServiceState {
		case models.ServiceStateNew:
			// Service has never been deployed - show Deploy button
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
				}) {
					@icon.Rocket(icon.Props{Class: "size-4 mr-1"})
					Deploy
				}
			</form>
		case models.ServiceStateDeploying:
			// Deployment in progress - show disabled button
			@button.Button(button.Props{
				Size: button.SizeSm,
				Disabled: true,
			}) {
				@icon.Loader(icon.Props{Class: "size-4 mr-1 animate-spin"})
				Deploying...
			}
		case models.ServiceStateRunning:
			// Service is running - show Stop, Reload, Rebuild buttons
			// Show Terminal button for non-database services
			if data.Service.SourceType != "database" {
				@button.Button(button.Props{
					Type: "button",
					Size: button.SizeSm,
					Variant: button.VariantOutline,
					Attributes: templ.Attributes{
						"onclick": "document.getElementById('terminal-dialog').showModal()",
					},
				}) {
					@icon.Terminal(icon.Props{Class: "size-4 mr-1"})
					Terminal
				}
			}
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/stop") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
					Variant: button.VariantOutline,
				}) {
					@icon.Square(icon.Props{Class: "size-4 mr-1"})
					Stop
				}
			</form>
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/reload") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
					Variant: button.VariantOutline,
				}) {
					@icon.RefreshCw(icon.Props{Class: "size-4 mr-1"})
					Reload
				}
			</form>
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
				}) {
					@icon.Hammer(icon.Props{Class: "size-4 mr-1"})
					Rebuild
				}
			</form>
		case models.ServiceStateStopped:
			// Service is stopped - show Start, Rebuild buttons
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/start") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
				}) {
					@icon.Play(icon.Props{Class: "size-4 mr-1"})
					Start
				}
			</form>
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
					Variant: button.VariantOutline,
				}) {
					@icon.Hammer(icon.Props{Class: "size-4 mr-1"})
					Rebuild
				}
			</form>
		case models.ServiceStateFailed:
			// Last deployment failed - show Retry, Rebuild buttons
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/retry") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
				}) {
					@icon.RotateCcw(icon.Props{Class: "size-4 mr-1"})
					Retry
				}
			</form>
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
					Variant: button.VariantOutline,
				}) {
					@icon.Hammer(icon.Props{Class: "size-4 mr-1"})
					Rebuild
				}
			</form>
		default:
			// Fallback - show Deploy button
			<form 
				method="POST" 
				action={ templ.SafeURL("/apps/" + data.App.ID + "/services/" + data.Service.Name + "/deploy") }
			>
				@button.Button(button.Props{
					Type: "submit",
					Size: button.SizeSm,
				}) {
					@icon.Rocket(icon.Props{Class: "size-4 mr-1"})
					Deploy
				}
			</form>
	}
}

// TerminalPanel renders the web terminal interface for a running service.
// **Validates: Requirements 23.1, 23.2, 23.3, 23.4, 23.5**
templ TerminalPanel(data ServiceDetailData) {
	<div class="space-y-4">
		@card.Card() {
			@card.Header() {
				<div class="flex items-center justify-between">
					<div>
						@card.Title() { 
							@icon.Terminal(icon.Props{Class: "size-5 mr-2 inline"})
							Service Terminal 
						}
						@card.Description() { 
							Interactive shell session for { data.Service.Name }
						}
					</div>
					<div class="flex items-center gap-2">
						@badge.Badge(badge.Props{ID: "terminal-status", Variant: badge.VariantOutline, Class: "h-6"}) {
							<span id="terminal-status-dot" class="mr-1.5 size-2 rounded-full bg-zinc-500"></span>
							<span id="terminal-status-text">Connecting...</span>
						}
					</div>
				</div>
			}
			@card.Content() {
				// Terminal container with theme-aware styling
				// **Validates: Requirements 23.3, 23.4**
				<div class="rounded-lg border border-border dark:border-zinc-800 overflow-hidden">
					// Terminal header bar
					<div class="flex items-center justify-between px-3 py-2 bg-muted/50 dark:bg-zinc-900/50 border-b border-border dark:border-zinc-800">
						<div class="flex items-center gap-2">
							<div class="flex items-center gap-1.5">
								<div class="size-3 rounded-full bg-red-500/30 border border-red-500/50"></div>
								<div class="size-3 rounded-full bg-amber-500/30 border border-amber-500/50"></div>
								<div class="size-3 rounded-full bg-emerald-500/30 border border-emerald-500/50"></div>
							</div>
							<span class="ml-2 text-xs font-medium text-muted-foreground uppercase tracking-wider">
								sh ‚Äî { data.Service.Name }
							</span>
						</div>
						<div class="flex items-center gap-2">
							@button.Button(button.Props{
								ID:      "terminal-reconnect-btn",
								Variant: button.VariantGhost,
								Size:    button.SizeIcon,
								Class:   "h-7 w-7 hidden",
								Attributes: templ.Attributes{"title": "Reconnect"},
							}) {
								@icon.RefreshCw(icon.Props{Size: 14})
							}
						</div>
					</div>
					// xterm.js terminal container
					<div 
						id="service-terminal" 
						class="h-[500px] w-full"
						data-app-id={ data.App.ID }
						data-service-name={ data.Service.Name }
					></div>
				</div>
				
				// Quick commands bar
				<div class="mt-4 flex flex-wrap items-center gap-2">
					<span class="text-xs text-muted-foreground font-medium uppercase">Quick commands:</span>
					@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Class: "h-7 text-xs terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "ps aux\n"}}) { 
						ps aux 
					}
					@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Class: "h-7 text-xs terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "ls -la\n"}}) { 
						ls -la 
					}
					@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Class: "h-7 text-xs terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "env\n"}}) { 
						env 
					}
					@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Class: "h-7 text-xs terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "df -h\n"}}) { 
						df -h 
					}
					@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Class: "h-7 text-xs terminal-quick-cmd", Attributes: templ.Attributes{"data-cmd": "free -m\n"}}) { 
						free -m 
					}
				</div>
			}
		}
		
		// Terminal initialization script
		// **Validates: Requirements 23.3, 23.4, 23.5**
		@TerminalScript(data.App.ID, data.Service.Name)
	</div>
}

// TerminalPanelDialog renders the web terminal interface for use inside a dialog.
// This version initializes the terminal when the dialog opens, not on page load.
// **Validates: Requirements 23.1, 23.2, 23.3, 23.4, 23.5**
templ TerminalPanelDialog(data ServiceDetailData) {
	<div class="space-y-4">
		// Terminal container with dark theme styling (matching server console)
		<div class="rounded-md bg-zinc-950 border border-zinc-800 overflow-hidden">
			// Terminal header bar
			<div class="flex items-center justify-between px-3 py-1.5 bg-zinc-900/50 border-b border-zinc-800">
				<div class="flex items-center gap-1.5">
					<div class="size-2.5 rounded-full bg-red-500/20 border border-red-500/40"></div>
					<div class="size-2.5 rounded-full bg-amber-500/20 border border-amber-500/40"></div>
					<div class="size-2.5 rounded-full bg-emerald-500/20 border border-emerald-500/40"></div>
					<span class="ml-2 text-[10px] font-medium text-zinc-500 uppercase tracking-wider">
						sh ‚Äî { data.Service.Name }
					</span>
				</div>
				<div class="flex items-center gap-2">
					@badge.Badge(badge.Props{ID: "dialog-terminal-status", Variant: badge.VariantOutline, Class: "h-5 text-[10px] px-1.5 border-zinc-800"}) {
						<span id="dialog-terminal-status-dot" class="mr-1 size-1.5 rounded-full bg-zinc-500"></span>
						<span id="dialog-terminal-status-text">Waiting</span>
					}
					@button.Button(button.Props{
						ID:      "dialog-terminal-reconnect-btn",
						Variant: button.VariantGhost,
						Size:    button.SizeIcon,
						Class:   "h-6 w-6 hidden text-zinc-400 hover:text-zinc-200",
						Attributes: templ.Attributes{"title": "Reconnect"},
					}) {
						@icon.RefreshCw(icon.Props{Size: 12})
					}
				</div>
			</div>
			// xterm.js terminal container
			<div 
				id="dialog-service-terminal" 
				class="h-[500px] w-full p-2"
				data-app-id={ data.App.ID }
				data-service-name={ data.Service.Name }
			></div>
		</div>
	</div>
	
	// Terminal initialization script that runs when dialog opens
	@TerminalDialogScript(data.App.ID, data.Service.Name)
}

// TerminalDialogScript renders the JavaScript for initializing the terminal when dialog opens.
// **Validates: Requirements 23.3, 23.4, 23.5**
templ TerminalDialogScript(appID string, serviceName string) {
	<script>
		(function() {
			const dialog = document.getElementById('terminal-dialog');
			const terminalContainer = document.getElementById('dialog-service-terminal');
			if (!dialog || !terminalContainer) return;
			
			const appId = terminalContainer.dataset.appId;
			const svcName = terminalContainer.dataset.serviceName;
			
			let term = null;
			let fitAddon = null;
			let ws = null;
			let reconnectAttempts = 0;
			let initialized = false;
			const maxReconnectAttempts = 5;
			const baseReconnectDelay = 1000;
			
			function getTerminalTheme() {
				const isDark = document.documentElement.classList.contains('dark') || 
					window.matchMedia('(prefers-color-scheme: dark)').matches;
				
				if (isDark) {
					return {
						background: '#09090b',
						foreground: '#d4d4d8',
						cursor: '#71717a',
						cursorAccent: '#09090b',
						selectionBackground: '#27272a',
						selectionForeground: '#fafafa',
						black: '#09090b',
						red: '#ef4444',
						green: '#22c55e',
						yellow: '#f59e0b',
						blue: '#3b82f6',
						magenta: '#a855f7',
						cyan: '#06b6d4',
						white: '#fafafa',
						brightBlack: '#71717a',
						brightRed: '#f87171',
						brightGreen: '#4ade80',
						brightYellow: '#fbbf24',
						brightBlue: '#60a5fa',
						brightMagenta: '#c084fc',
						brightCyan: '#22d3ee',
						brightWhite: '#ffffff'
					};
				} else {
					return {
						background: '#fafafa',
						foreground: '#18181b',
						cursor: '#71717a',
						cursorAccent: '#fafafa',
						selectionBackground: '#e4e4e7',
						selectionForeground: '#18181b',
						black: '#18181b',
						red: '#dc2626',
						green: '#16a34a',
						yellow: '#ca8a04',
						blue: '#2563eb',
						magenta: '#9333ea',
						cyan: '#0891b2',
						white: '#fafafa',
						brightBlack: '#52525b',
						brightRed: '#ef4444',
						brightGreen: '#22c55e',
						brightYellow: '#eab308',
						brightBlue: '#3b82f6',
						brightMagenta: '#a855f7',
						brightCyan: '#06b6d4',
						brightWhite: '#ffffff'
					};
				}
			}
			
			function updateStatus(status, message) {
				const dot = document.getElementById('dialog-terminal-status-dot');
				const text = document.getElementById('dialog-terminal-status-text');
				const reconnectBtn = document.getElementById('dialog-terminal-reconnect-btn');
				
				if (dot && text) {
					switch (status) {
						case 'connected':
							dot.className = 'mr-1 size-1.5 rounded-full bg-emerald-500';
							text.textContent = 'Connected';
							if (reconnectBtn) reconnectBtn.classList.add('hidden');
							break;
						case 'connecting':
							dot.className = 'mr-1 size-1.5 rounded-full bg-amber-500 animate-pulse';
							text.textContent = message || 'Connecting';
							if (reconnectBtn) reconnectBtn.classList.add('hidden');
							break;
						case 'disconnected':
							dot.className = 'mr-1 size-1.5 rounded-full bg-red-500';
							text.textContent = message || 'Disconnected';
							if (reconnectBtn) reconnectBtn.classList.remove('hidden');
							break;
						case 'error':
							dot.className = 'mr-1 size-1.5 rounded-full bg-red-500';
							text.textContent = message || 'Error';
							if (reconnectBtn) reconnectBtn.classList.remove('hidden');
							break;
					}
				}
			}
			
			function initTerminal() {
				if (term) return;
				
				term = new Terminal({
					cursorBlink: true,
					cursorStyle: 'underline',
					theme: getTerminalTheme(),
					fontSize: 14,
					lineHeight: 1.2,
					fontFamily: '"JetBrains Mono", Menlo, Monaco, Consolas, "Courier New", monospace',
					scrollback: 5000,
					convertEol: true
				});
				
				fitAddon = new FitAddon.FitAddon();
				term.loadAddon(fitAddon);
				term.open(terminalContainer);
				
				// Delay fit to ensure container is visible
				setTimeout(() => {
					fitAddon.fit();
				}, 100);
				
				term.onData(data => {
					if (ws && ws.readyState === WebSocket.OPEN) {
						ws.send(data);
					}
				});
				
				window.addEventListener('resize', () => {
					if (fitAddon && dialog.open) {
						fitAddon.fit();
						sendResize();
					}
				});
			}
			
			function sendResize() {
				if (ws && ws.readyState === WebSocket.OPEN && term) {
					ws.send(JSON.stringify({
						type: 'resize',
						rows: term.rows,
						cols: term.cols
					}));
				}
			}
			
			function connect() {
				if (ws && ws.readyState === WebSocket.OPEN) return;
				
				updateStatus('connecting');
				
				const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
				const wsUrl = `${protocol}//${window.location.host}/apps/${appId}/services/${svcName}/terminal/ws`;
				
				ws = new WebSocket(wsUrl);
				ws.binaryType = 'arraybuffer';
				
				ws.onopen = () => {
					reconnectAttempts = 0;
					updateStatus('connected');
					if (term) {
						term.focus();
						setTimeout(() => {
							if (fitAddon) fitAddon.fit();
							sendResize();
						}, 50);
					}
				};
				
				ws.onmessage = (event) => {
					if (term) {
						term.write(new Uint8Array(event.data));
					}
				};
				
				ws.onclose = (event) => {
					updateStatus('disconnected', 'Connection closed');
					if (term) {
						term.write('\r\n\x1b[31mTerminal connection closed.\x1b[0m\r\n');
					}
					
					// Only auto-reconnect if dialog is still open
					if (dialog.open && reconnectAttempts < maxReconnectAttempts) {
						const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts);
						reconnectAttempts++;
						updateStatus('connecting', `Reconnecting in ${delay/1000}s...`);
						setTimeout(() => {
							if (dialog.open) connect();
						}, delay);
					}
				};
				
				ws.onerror = (error) => {
					console.error('WebSocket error:', error);
					updateStatus('error', 'Connection error');
				};
			}
			
			function cleanup() {
				if (ws) {
					ws.send(JSON.stringify({ type: 'terminate' }));
					ws.close();
					ws = null;
				}
			}
			
			// Initialize when dialog opens
			dialog.addEventListener('open', () => {
				if (!initialized) {
					initTerminal();
					initialized = true;
				}
				reconnectAttempts = 0;
				connect();
			});
			
			// Also handle the native showModal which doesn't fire 'open' event
			const originalShowModal = dialog.showModal.bind(dialog);
			dialog.showModal = function() {
				originalShowModal();
				if (!initialized) {
					initTerminal();
					initialized = true;
				}
				reconnectAttempts = 0;
				connect();
			};
			
			// Cleanup when dialog closes
			dialog.addEventListener('close', () => {
				cleanup();
			});
			
			// Quick command buttons
			document.querySelectorAll('.dialog-terminal-quick-cmd').forEach(btn => {
				btn.addEventListener('click', () => {
					const cmd = btn.getAttribute('data-cmd');
					if (ws && ws.readyState === WebSocket.OPEN) {
						ws.send(cmd);
					}
					if (term) term.focus();
				});
			});
			
			// Reconnect button
			const reconnectBtn = document.getElementById('dialog-terminal-reconnect-btn');
			if (reconnectBtn) {
				reconnectBtn.addEventListener('click', () => {
					reconnectAttempts = 0;
					connect();
				});
			}
			
			// Cleanup on page unload
			window.addEventListener('beforeunload', () => {
				cleanup();
			});
		})();
	</script>
}

// TerminalScript renders the JavaScript for initializing and managing the terminal.
// **Validates: Requirements 23.3, 23.4, 23.5**
templ TerminalScript(appID string, serviceName string) {
	<script>
		(function() {
			const terminalContainer = document.getElementById('service-terminal');
			if (!terminalContainer) return;
			
			const appId = terminalContainer.dataset.appId;
			const svcName = terminalContainer.dataset.serviceName;
			
			let term = null;
			let fitAddon = null;
			let ws = null;
			let reconnectAttempts = 0;
			const maxReconnectAttempts = 5;
			const baseReconnectDelay = 1000;
			
			// Theme detection for xterm.js
			// **Validates: Requirements 23.3, 23.4**
			function getTerminalTheme() {
				const isDark = document.documentElement.classList.contains('dark') || 
					window.matchMedia('(prefers-color-scheme: dark)').matches;
				
				if (isDark) {
					return {
						background: '#09090b',
						foreground: '#d4d4d8',
						cursor: '#71717a',
						cursorAccent: '#09090b',
						selectionBackground: '#27272a',
						selectionForeground: '#fafafa',
						black: '#09090b',
						red: '#ef4444',
						green: '#22c55e',
						yellow: '#f59e0b',
						blue: '#3b82f6',
						magenta: '#a855f7',
						cyan: '#06b6d4',
						white: '#fafafa',
						brightBlack: '#71717a',
						brightRed: '#f87171',
						brightGreen: '#4ade80',
						brightYellow: '#fbbf24',
						brightBlue: '#60a5fa',
						brightMagenta: '#c084fc',
						brightCyan: '#22d3ee',
						brightWhite: '#ffffff'
					};
				} else {
					return {
						background: '#fafafa',
						foreground: '#18181b',
						cursor: '#71717a',
						cursorAccent: '#fafafa',
						selectionBackground: '#e4e4e7',
						selectionForeground: '#18181b',
						black: '#18181b',
						red: '#dc2626',
						green: '#16a34a',
						yellow: '#ca8a04',
						blue: '#2563eb',
						magenta: '#9333ea',
						cyan: '#0891b2',
						white: '#fafafa',
						brightBlack: '#52525b',
						brightRed: '#ef4444',
						brightGreen: '#22c55e',
						brightYellow: '#eab308',
						brightBlue: '#3b82f6',
						brightMagenta: '#a855f7',
						brightCyan: '#06b6d4',
						brightWhite: '#ffffff'
					};
				}
			}
			
			function updateStatus(status, message) {
				const dot = document.getElementById('terminal-status-dot');
				const text = document.getElementById('terminal-status-text');
				const reconnectBtn = document.getElementById('terminal-reconnect-btn');
				
				if (dot && text) {
					switch (status) {
						case 'connected':
							dot.className = 'mr-1.5 size-2 rounded-full bg-emerald-500';
							text.textContent = 'Connected';
							if (reconnectBtn) reconnectBtn.classList.add('hidden');
							break;
						case 'connecting':
							dot.className = 'mr-1.5 size-2 rounded-full bg-amber-500 animate-pulse';
							text.textContent = message || 'Connecting...';
							if (reconnectBtn) reconnectBtn.classList.add('hidden');
							break;
						case 'disconnected':
							dot.className = 'mr-1.5 size-2 rounded-full bg-red-500';
							text.textContent = message || 'Disconnected';
							if (reconnectBtn) reconnectBtn.classList.remove('hidden');
							break;
						case 'error':
							dot.className = 'mr-1.5 size-2 rounded-full bg-red-500';
							text.textContent = message || 'Error';
							if (reconnectBtn) reconnectBtn.classList.remove('hidden');
							break;
					}
				}
			}
			
			function initTerminal() {
				if (term) return;
				
				term = new Terminal({
					cursorBlink: true,
					cursorStyle: 'underline',
					theme: getTerminalTheme(),
					fontSize: 14,
					lineHeight: 1.2,
					fontFamily: '"JetBrains Mono", Menlo, Monaco, Consolas, "Courier New", monospace',
					scrollback: 5000,
					convertEol: true
				});
				
				fitAddon = new FitAddon.FitAddon();
				term.loadAddon(fitAddon);
				term.open(terminalContainer);
				fitAddon.fit();
				
				// Handle terminal input
				term.onData(data => {
					if (ws && ws.readyState === WebSocket.OPEN) {
						ws.send(data);
					}
				});
				
				// Handle window resize
				window.addEventListener('resize', () => {
					if (fitAddon) {
						fitAddon.fit();
						sendResize();
					}
				});
				
				// Watch for theme changes
				// **Validates: Requirements 23.4**
				const observer = new MutationObserver(() => {
					if (term) {
						term.options.theme = getTerminalTheme();
					}
				});
				observer.observe(document.documentElement, { 
					attributes: true, 
					attributeFilter: ['class'] 
				});
				
				// Also listen for system theme changes
				window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
					if (term) {
						term.options.theme = getTerminalTheme();
					}
				});
			}
			
			function sendResize() {
				if (ws && ws.readyState === WebSocket.OPEN && term) {
					ws.send(JSON.stringify({
						type: 'resize',
						rows: term.rows,
						cols: term.cols
					}));
				}
			}
			
			function connect() {
				if (ws && ws.readyState === WebSocket.OPEN) return;
				
				updateStatus('connecting');
				
				const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
				const wsUrl = `${protocol}//${window.location.host}/apps/${appId}/services/${svcName}/terminal/ws`;
				
				ws = new WebSocket(wsUrl);
				ws.binaryType = 'arraybuffer';
				
				ws.onopen = () => {
					reconnectAttempts = 0;
					updateStatus('connected');
					if (term) {
						term.focus();
						sendResize();
					}
				};
				
				ws.onmessage = (event) => {
					if (term) {
						term.write(new Uint8Array(event.data));
					}
				};
				
				// **Validates: Requirements 23.5** - Reconnection handling
				ws.onclose = (event) => {
					updateStatus('disconnected', 'Connection closed');
					if (term) {
						term.write('\r\n\x1b[31mTerminal connection closed.\x1b[0m\r\n');
					}
					
					// Auto-reconnect with exponential backoff
					if (reconnectAttempts < maxReconnectAttempts) {
						const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts);
						reconnectAttempts++;
						updateStatus('connecting', `Reconnecting in ${delay/1000}s...`);
						setTimeout(connect, delay);
					}
				};
				
				ws.onerror = (error) => {
					console.error('WebSocket error:', error);
					updateStatus('error', 'Connection error');
				};
			}
			
			// Initialize terminal and connect
			initTerminal();
			connect();
			
			// Quick command buttons
			document.querySelectorAll('.terminal-quick-cmd').forEach(btn => {
				btn.addEventListener('click', () => {
					const cmd = btn.getAttribute('data-cmd');
					if (ws && ws.readyState === WebSocket.OPEN) {
						ws.send(cmd);
					}
					if (term) term.focus();
				});
			});
			
			// Reconnect button
			const reconnectBtn = document.getElementById('terminal-reconnect-btn');
			if (reconnectBtn) {
				reconnectBtn.addEventListener('click', () => {
					reconnectAttempts = 0;
					connect();
				});
			}
			
			// Cleanup on page unload
			window.addEventListener('beforeunload', () => {
				if (ws) {
					ws.send(JSON.stringify({ type: 'terminate' }));
					ws.close();
				}
			});
		})();
	</script>
}
