package pages

import (
	"fmt"
	
	"github.com/narvanalabs/control-plane/web/layouts"
	"github.com/narvanalabs/control-plane/web/components/card"
	"github.com/narvanalabs/control-plane/web/components/icon"
	"github.com/narvanalabs/control-plane/web/components/badge"
	"github.com/narvanalabs/control-plane/web/components/button"
	"github.com/narvanalabs/control-plane/web/components/table"
	"github.com/narvanalabs/control-plane/web/api"
)

// DashboardData holds the data for the dashboard page
type DashboardData struct {
	TotalApps         int
	ActiveDeployments int
	HealthyNodes      int
	RunningBuilds     int
	RecentDeployments []api.RecentDeployment
	NodeHealth        []api.NodeHealth
}

// Dashboard renders the main dashboard page
templ Dashboard(data DashboardData) {
	@layouts.PageWithSidebar("Dashboard", "/") {
		<div class="space-y-6">
			<div>
				<h1 class="text-2xl font-bold">Dashboard</h1>
				<p class="text-muted-foreground">Overview of your Narvana Control Plane</p>
			</div>
			
			// Empty State CTAs - Show when no apps or no nodes
			if data.TotalApps == 0 || data.HealthyNodes == 0 {
				<div class="grid gap-4 md:grid-cols-2">
					if data.TotalApps == 0 {
						@EmptyStateApps()
					}
					if data.HealthyNodes == 0 {
						@EmptyStateNodes()
					}
				</div>
			}
			
			// Stats Cards
			<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
				@StatCardApps(data.TotalApps)
				@StatCardDeployments(data.ActiveDeployments)
				@StatCardNodes(data.HealthyNodes)
				@StatCardBuilds(data.RunningBuilds)
			</div>
			
			// Recent Activity
			<div class="grid gap-4 lg:grid-cols-2">
				@card.Card() {
					@card.Header() {
						@card.Title() {
							Recent Deployments
						}
						@card.Description() {
							Latest deployment activity
						}
					}
					@card.Content() {
						if len(data.RecentDeployments) == 0 {
							<div class="text-center py-8 text-muted-foreground">
								<p>No deployments yet</p>
								<p class="text-sm mt-1">Deploy your first app to see activity here</p>
							</div>
						} else {
							@table.Table() {
								@table.Header() {
									@table.Row() {
										@table.Head() { App }
										@table.Head() { Service }
										@table.Head() { Status }
										@table.Head() { Time }
									}
								}
								@table.Body() {
									for _, d := range data.RecentDeployments {
										@table.Row() {
											@table.Cell() { { d.AppName } }
											@table.Cell() { { d.ServiceName } }
											@table.Cell() { 
												@DeploymentStatusBadge(d.Status)
											}
											@table.Cell() { { d.TimeAgo } }
										}
									}
								}
							}
						}
					}
				}
				
				@card.Card() {
					@card.Header() {
						@card.Title() {
							Node Health
						}
						@card.Description() {
							Status of compute nodes
						}
					}
					@card.Content() {
						if len(data.NodeHealth) == 0 {
							<div class="text-center py-8 text-muted-foreground">
								<p>No nodes registered</p>
								<p class="text-sm mt-1">Register a node to start deploying</p>
							</div>
						} else {
							<div class="space-y-3">
								for _, n := range data.NodeHealth {
									@NodeHealthItem(n.Name, n.Address, n.Healthy, n.CPUPercent, n.MemPercent)
								}
							</div>
						}
					}
				}
			</div>
		</div>
	}
}

// EmptyStateApps renders the empty state CTA for creating the first app
templ EmptyStateApps() {
	@card.Card(card.Props{Class: "border-dashed border-2 bg-muted/30"}) {
		@card.Content(card.ContentProps{Class: "py-8"}) {
			<div class="flex flex-col items-center justify-center text-center">
				<div class="rounded-full bg-primary/10 p-4 mb-4">
					@icon.Box(icon.Props{Class: "size-8 text-primary"})
				</div>
				<h3 class="text-lg font-semibold">Create your first app</h3>
				<p class="text-muted-foreground mt-1 mb-4 text-sm max-w-xs">
					Get started by creating an application to deploy your services.
				</p>
				@button.Button(button.Props{Href: "/apps"}) {
					@icon.Plus(icon.Props{Class: "size-4 mr-2"})
					Create App
				}
			</div>
		}
	}
}

// EmptyStateNodes renders the empty state CTA for registering the first node
templ EmptyStateNodes() {
	@card.Card(card.Props{Class: "border-dashed border-2 bg-muted/30"}) {
		@card.Content(card.ContentProps{Class: "py-8"}) {
			<div class="flex flex-col items-center justify-center text-center">
				<div class="rounded-full bg-primary/10 p-4 mb-4">
					@icon.Server(icon.Props{Class: "size-8 text-primary"})
				</div>
				<h3 class="text-lg font-semibold">Register your first node</h3>
				<p class="text-muted-foreground mt-1 mb-4 text-sm max-w-xs">
					Add a compute node to start deploying your applications.
				</p>
				@button.Button(button.Props{Href: "/nodes"}) {
					@icon.Plus(icon.Props{Class: "size-4 mr-2"})
					Add Node
				}
			</div>
		}
	}
}

// DeploymentStatusBadge renders a status badge for deployments
templ DeploymentStatusBadge(status string) {
	switch status {
		case "running":
			@badge.Badge(badge.Props{Variant: badge.VariantDefault}) { running }
		case "building":
			@badge.Badge(badge.Props{Variant: badge.VariantSecondary}) { building }
		case "pending":
			@badge.Badge(badge.Props{Variant: badge.VariantOutline}) { pending }
		case "failed":
			@badge.Badge(badge.Props{Variant: badge.VariantDestructive}) { failed }
		default:
			@badge.Badge(badge.Props{Variant: badge.VariantOutline}) { { status } }
	}
}

// StatCardApps renders the apps stats card
templ StatCardApps(value int) {
	@card.Card() {
		@card.Header(card.HeaderProps{Class: "flex flex-row items-center justify-between space-y-0 pb-2"}) {
			@card.Title(card.TitleProps{Class: "text-sm font-medium"}) {
				Total Apps
			}
			@icon.Box(icon.Props{Class: "size-4 text-muted-foreground"})
		}
		@card.Content() {
			<div class="text-2xl font-bold">{ fmt.Sprintf("%d", value) }</div>
			<a href="/apps" class="text-xs text-muted-foreground hover:underline">
				View all →
			</a>
		}
	}
}

// StatCardDeployments renders the deployments stats card
templ StatCardDeployments(value int) {
	@card.Card() {
		@card.Header(card.HeaderProps{Class: "flex flex-row items-center justify-between space-y-0 pb-2"}) {
			@card.Title(card.TitleProps{Class: "text-sm font-medium"}) {
				Active Deployments
			}
			@icon.Rocket(icon.Props{Class: "size-4 text-muted-foreground"})
		}
		@card.Content() {
			<div class="text-2xl font-bold">{ fmt.Sprintf("%d", value) }</div>
			<a href="/deployments" class="text-xs text-muted-foreground hover:underline">
				View all →
			</a>
		}
	}
}

// StatCardNodes renders the nodes stats card
templ StatCardNodes(value int) {
	@card.Card() {
		@card.Header(card.HeaderProps{Class: "flex flex-row items-center justify-between space-y-0 pb-2"}) {
			@card.Title(card.TitleProps{Class: "text-sm font-medium"}) {
				Healthy Nodes
			}
			@icon.Server(icon.Props{Class: "size-4 text-muted-foreground"})
		}
		@card.Content() {
			<div class="text-2xl font-bold">{ fmt.Sprintf("%d", value) }</div>
			<a href="/nodes" class="text-xs text-muted-foreground hover:underline">
				View all →
			</a>
		}
	}
}

// StatCardBuilds renders the builds stats card
templ StatCardBuilds(value int) {
	@card.Card() {
		@card.Header(card.HeaderProps{Class: "flex flex-row items-center justify-between space-y-0 pb-2"}) {
			@card.Title(card.TitleProps{Class: "text-sm font-medium"}) {
				Running Builds
			}
			@icon.Hammer(icon.Props{Class: "size-4 text-muted-foreground"})
		}
		@card.Content() {
			<div class="text-2xl font-bold">{ fmt.Sprintf("%d", value) }</div>
			<a href="/builds" class="text-xs text-muted-foreground hover:underline">
				View all →
			</a>
		}
	}
}

// NodeHealthItem renders a node health status item
templ NodeHealthItem(name string, address string, healthy bool, cpuPercent int, memPercent int) {
	<div class="flex items-center justify-between rounded-lg border p-3">
		<div class="flex items-center gap-3">
			if healthy {
				<div class="size-2 rounded-full bg-green-500"></div>
			} else {
				<div class="size-2 rounded-full bg-red-500"></div>
			}
			<div>
				<div class="font-medium">{ name }</div>
				<div class="text-xs text-muted-foreground">{ address }</div>
			</div>
		</div>
		if healthy {
			<div class="text-xs text-muted-foreground">
				CPU: { fmt.Sprintf("%d", cpuPercent) }% | Mem: { fmt.Sprintf("%d", memPercent) }%
			</div>
		} else {
			@badge.Badge(badge.Props{Variant: badge.VariantDestructive}) { offline }
		}
	</div>
}
