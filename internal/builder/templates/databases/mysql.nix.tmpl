{
  description = "Narvana MySQL Database: {{ .AppName }}/{{ .ServiceName }}";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  };

  outputs = { self, nixpkgs }:
    let
      system = "{{ .System }}";
      pkgs = nixpkgs.legacyPackages.${system};
      
      dbVersion = "{{ .DatabaseVersion }}";
      
      # Select MySQL package based on version
      mysqlPkg = 
        if dbVersion == "5.7" then pkgs.mysql57
        else if dbVersion == "8.0" then pkgs.mysql80
        else if dbVersion == "8.4" then pkgs.mysql84
        else pkgs.mysql80; # Default to 8.0
      
      maxConnections = "{{ index .Config "max_connections" }}";
      innodbBufferPoolSize = "{{ index .Config "innodb_buffer_pool_size" }}";
    in
    {
      packages.${system}.default = pkgs.stdenv.mkDerivation {
        pname = "{{ .AppName }}-{{ .ServiceName }}";
        version = "1.0.0";
        src = ./.;

        buildInputs = [ mysqlPkg ];

        buildPhase = ''
          mkdir -p $out/bin
          mkdir -p $out/share
          
          echo "Creating MySQL ${dbVersion} scripts..."
          
          # Create initialization script
          cat > $out/bin/init-mysql.sh <<'INITEOF'
#!/usr/bin/env bash
set -e

MYSQL_DATADIR="$1"
MYSQL_PORT="''${MYSQL_PORT:-3306}"
DB_NAME="''${DB_NAME:-narvana}"
DB_USER="''${DB_USER:-narvana}"
DB_PASSWORD="''${DB_PASSWORD:-narvana}"
MYSQL_ROOT_PASSWORD="''${MYSQL_ROOT_PASSWORD:-root}"

if [ ! -d "$MYSQL_DATADIR/mysql" ]; then
  echo "Initializing MySQL data directory..."
  mysqld --initialize-insecure --datadir="$MYSQL_DATADIR"
  
  echo "MySQL data directory initialized"
fi

# Start MySQL temporarily for setup
mysqld --datadir="$MYSQL_DATADIR" --port="$MYSQL_PORT" --socket=/tmp/mysql.sock &
MYSQL_PID=$!
sleep 5

# Set root password and create database/user
mysql -u root --socket=/tmp/mysql.sock <<SQL
ALTER USER 'root'@'localhost' IDENTIFIED BY '$MYSQL_ROOT_PASSWORD';
CREATE DATABASE IF NOT EXISTS $DB_NAME;
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;

USE $DB_NAME;
CREATE TABLE IF NOT EXISTS _narvana_meta (
  \`key\` VARCHAR(255) PRIMARY KEY,
  value TEXT,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
INSERT INTO _narvana_meta (\`key\`, value) VALUES ('db_type', 'mysql') ON DUPLICATE KEY UPDATE value=value;
INSERT INTO _narvana_meta (\`key\`, value) VALUES ('db_version', '${dbVersion}') ON DUPLICATE KEY UPDATE value=value;
SQL

# Stop MySQL
kill $MYSQL_PID
wait $MYSQL_PID 2>/dev/null || true

echo "MySQL initialization complete"
INITEOF
          
          # Create startup script
          cat > $out/bin/start-mysql.sh <<'STARTEOF'
#!/usr/bin/env bash
set -e

MYSQL_DATADIR="''${MYSQL_DATADIR:-/app/data/mysql}"
MYSQL_PORT="''${MYSQL_PORT:-3306}"

# Initialize if needed
if [ ! -d "$MYSQL_DATADIR/mysql" ]; then
  echo "Initializing MySQL..."
  init-mysql.sh "$MYSQL_DATADIR"
fi

# Start MySQL
echo "Starting MySQL on port $MYSQL_PORT..."
exec mysqld \
  --datadir="$MYSQL_DATADIR" \
  --port="$MYSQL_PORT" \
  --bind-address=0.0.0.0 \
  --max-connections=${maxConnections} \
  --innodb-buffer-pool-size=${innodbBufferPoolSize}
STARTEOF
          
          # Create entrypoint script
          cat > $out/bin/entrypoint.sh <<'ENTRYEOF'
#!/usr/bin/env bash
set -e

if [ "$1" = "mysql" ] || [ "$1" = "mysqld" ] || [ "$1" = "start" ] || [ -z "$1" ]; then
  exec start-mysql.sh
else
  exec "$@"
fi
ENTRYEOF
          
          chmod +x $out/bin/*.sh
        '';

        installPhase = ''
          # Create wrapper that sets up environment
          cat > $out/bin/database <<'WRAPEOF'
#!/usr/bin/env bash
export DATABASE_URL="mysql://''${DB_USER:-narvana}:''${DB_PASSWORD:-narvana}@localhost:''${MYSQL_PORT:-3306}/''${DB_NAME:-narvana}"
export MYSQL_DATADIR="''${MYSQL_DATADIR:-/app/data/mysql}"
export MYSQL_PORT="''${MYSQL_PORT:-3306}"
exec "$@"
WRAPEOF
          chmod +x $out/bin/database
          
          # Wrap each script to ensure MySQL binaries are in PATH
          for script in init-mysql.sh start-mysql.sh entrypoint.sh; do
            mv $out/bin/$script $out/bin/.$script
            cat > $out/bin/$script <<EOF
#!/usr/bin/env bash
export PATH="${mysqlPkg}/bin:\$PATH"
exec $out/bin/.$script "\$@"
EOF
            chmod +x $out/bin/$script
          done
        '';
      };
    };
}
